# ç¬¬1ç« ï¼šå‡ ä½•å…‰å­¦ä¸æ¸²æŸ“åŸºç¡€

æœ¬ç« é€šè¿‡å‡ ä½•å…‰å­¦çš„è§†è§’å»ºç«‹è®¡ç®—æœºå›¾å½¢å­¦çš„æ•°å­¦åŸºç¡€ã€‚æˆ‘ä»¬å°†æ¸²æŸ“æ–¹ç¨‹ä½œä¸ºæ ¸å¿ƒæ¡†æ¶ï¼Œä»‹ç»å…³é”®çš„è¾å°„åº¦é‡æ¦‚å¿µï¼Œå¹¶å»ºç«‹è·¯å¾„ç§¯åˆ†è¡¨è¿°ï¼Œè¿™å°†ç»Ÿä¸€æ‰€æœ‰åç»­çš„æ¸²æŸ“æŠ€æœ¯ã€‚é€šè¿‡å°†å…‰ä¼ è¾“è§†ä¸ºé«˜ç»´ç§¯åˆ†é—®é¢˜ï¼Œæˆ‘ä»¬ä¸ºç†è§£åŸºäºç‚¹çš„æ¸²æŸ“ã€åŸºäºå›¾åƒçš„æ¸²æŸ“å’Œç¥ç»æ¸²æŸ“æ–¹æ³•ä½œä¸ºè§£å†³åŒä¸€åŸºæœ¬æ–¹ç¨‹çš„ä¸åŒæ–¹æ³•å¥ å®šäº†åŸºç¡€ã€‚

## å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š
1. ä½¿ç”¨èƒ½é‡å®ˆæ’ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼æ¸²æŸ“æ–¹ç¨‹
2. åœ¨ä¿æŒè¾å°„åº¦é‡ä¸å˜çš„æƒ…å†µä¸‹åœ¨ä¸åŒåæ ‡ç³»ä¹‹é—´è½¬æ¢
3. åˆ†æBRDFå±æ€§å¹¶éªŒè¯ç‰©ç†åˆç†æ€§
4. åº”ç”¨è’™ç‰¹å¡æ´›æ–¹æ³•ä¼°è®¡å…·æœ‰å·²çŸ¥è¯¯å·®ç•Œé™çš„é«˜ç»´ç§¯åˆ†
5. å°†å…‰ä¼ è¾“è¡¨è¾¾ä¸ºè·¯å¾„ç§¯åˆ†å¹¶å°†å…¶ä¸ä½“ç§¯æ¸²æŸ“è”ç³»èµ·æ¥

## 1.1 å…‰çº¿è¿½è¸ªåŸºç¡€ä¸æ¸²æŸ“æ–¹ç¨‹

### å‡ ä½•å…‰å­¦ä¸­çš„å…‰çº¿

åœ¨å‡ ä½•å…‰å­¦ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å…‰çº¿æ¥å»ºæ¨¡å…‰çš„ä¼ æ’­â€”â€”åœ¨å‡åŒ€ä»‹è´¨ä¸­æ²¿ç›´çº¿ä¼ æ’­çš„æ— é™ç»†å…‰æŸã€‚å½“æ³¢é•¿ Î» << ç‰¹å¾å°ºå¯¸æ—¶ï¼Œè¿™ç§è¿‘ä¼¼æˆç«‹ï¼Œä½¿æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¡å°„å’Œå¹²æ¶‰ã€‚å…‰çº¿å‚æ•°åŒ–ä¸ºï¼š

**r**(t) = **o** + t**d**

å…¶ä¸­ **o** âˆˆ â„Â³ æ˜¯åŸç‚¹ï¼Œ**d** âˆˆ â„Â³ æ˜¯æ–¹å‘ï¼ˆ||**d**|| = 1ï¼‰ï¼Œt â‰¥ 0 æ˜¯æ²¿å…‰çº¿çš„å‚æ•°ã€‚

å…‰çº¿æ–¹ç¨‹æºè‡ªç¨‹å‡½æ–¹ç¨‹ âˆ‡S = n**kÌ‚** åœ¨ Î» â†’ 0 æé™ä¸‹çš„ç»“æœï¼Œå…¶ä¸­ S æ˜¯ç›¸ä½ï¼Œn æ˜¯æŠ˜å°„ç‡ã€‚åœ¨éå‡åŒ€ä»‹è´¨ä¸­ï¼Œå…‰çº¿éµå¾ªæ»¡è¶³ä»¥ä¸‹æ–¹ç¨‹çš„æ›²çº¿è·¯å¾„ï¼š

$\frac{d}{ds}\left(n \frac{d\mathbf{r}}{ds}\right) = \nabla n$

å½“ n ä¸ºå¸¸æ•°æ—¶ï¼Œè¿™ç®€åŒ–ä¸ºç›´çº¿ã€‚

**ä¸æ³¢åŠ¨å…‰å­¦çš„è”ç³»**ï¼šå‡ ä½•å…‰å­¦è¿‘ä¼¼æºè‡ªæ³¢åŠ¨æ–¹ç¨‹çš„WKBï¼ˆWentzel-Kramers-Brillouinï¼‰è¿‘ä¼¼ã€‚å½“æˆ‘ä»¬å°† Ïˆ = A exp(ikS) ä»£å…¥äº¥å§†éœå…¹æ–¹ç¨‹å¹¶å– k â†’ âˆ æ—¶ï¼š

$\nabla^2\psi + k^2n^2\psi = 0 \rightarrow (\nabla S)^2 = n^2$ ï¼ˆç¨‹å‡½æ–¹ç¨‹ï¼‰

ç­‰ç›¸ä½é¢ S = const æ˜¯æ³¢å‰ï¼Œå…‰çº¿æ˜¯è¿™äº›æ³¢å‰çš„æ­£äº¤è½¨è¿¹ã€‚å½“æˆ‘ä»¬åœ¨åç»­ç« èŠ‚æ‰©å±•åˆ°æ³¢åŠ¨å…‰å­¦æ—¶ï¼Œè¿™ç§è”ç³»å˜å¾—è‡³å…³é‡è¦ã€‚

**å…‰çº¿å…‰å­¦çš„æœ‰æ•ˆæ€§**ï¼šå‡ ä½•å…‰å­¦è¿‘ä¼¼åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¤±æ•ˆï¼š
1. ç‰¹å¾å°ºå¯¸ ~ æ³¢é•¿ï¼ˆè¡å°„å˜å¾—æ˜¾è‘—ï¼‰
2. é è¿‘ç„¦æ•£é¢ï¼Œå…‰çº¿å¯†åº¦ â†’ âˆ
3. å­˜åœ¨å°–é”è¾¹ç¼˜æˆ–ä¸è¿ç»­æ€§
4. éœ€è¦ç›¸ä½ä¿¡æ¯çš„ç›¸å¹²ç°è±¡

**è´¹é©¬åŸç†**ï¼šå…‰çº¿éµå¾ªå…‰ç¨‹ç¨³å®šçš„è·¯å¾„ï¼š

$\delta\int n(\mathbf{r}) ds = 0$

è¿™ä¸ªå˜åˆ†åŸç†ç»Ÿä¸€äº†å…‰çº¿è¡Œä¸ºï¼šåœ¨å‡åŒ€ä»‹è´¨ä¸­çš„ç›´çº¿ã€ç•Œé¢å¤„çš„æ–¯æ¶…å°”å®šå¾‹ä»¥åŠæ¢¯åº¦æŠ˜å°„ç‡ä»‹è´¨ä¸­çš„æ›²çº¿è·¯å¾„ã€‚å®ƒè¿˜ä¸ç‰©ç†å­¦ä¸­çš„æœ€å°ä½œç”¨é‡åŸç†å’Œå¾®åˆ†å‡ ä½•ä¸­çš„æµ‹åœ°çº¿æ–¹ç¨‹ç›¸å…³è”ã€‚

### è¾å°„åº¦é‡

åœ¨æ¨å¯¼æ¸²æŸ“æ–¹ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å»ºç«‹è¾å°„åº¦é‡æ¡†æ¶ã€‚è¿™äº›é‡å½¢æˆä¸€ä¸ªå±‚æ¬¡ç»“æ„ï¼Œæ¯ä¸ªéƒ½å»ºç«‹åœ¨å‰ä¸€ä¸ªçš„åŸºç¡€ä¸Šï¼š

**è¾å°„èƒ½** Q æµ‹é‡æ€»ç”µç£èƒ½é‡ï¼š
Q [J]

**è¾å°„é€šé‡ï¼ˆåŠŸç‡ï¼‰** Î¦ æµ‹é‡å•ä½æ—¶é—´çš„èƒ½é‡ï¼š
$\Phi = \frac{dQ}{dt}$ [W]

**è¾å°„å¼ºåº¦** I æµ‹é‡ç‚¹æºå•ä½ç«‹ä½“è§’çš„é€šé‡ï¼š
$I = \frac{d\Phi}{d\omega}$ [W/sr]

**è¾ç…§åº¦** E æµ‹é‡å…¥å°„å•ä½é¢ç§¯çš„é€šé‡ï¼š
$E = \frac{d\Phi}{dA}$ [W/mÂ²]

**è¾å°„å‡ºå°„åº¦** M æµ‹é‡ç¦»å¼€å•ä½é¢ç§¯çš„é€šé‡ï¼š
$M = \frac{d\Phi}{dA}$ [W/mÂ²]

**è¾å°„ç‡** L æµ‹é‡å•ä½é¢ç§¯å•ä½ç«‹ä½“è§’çš„é€šé‡ï¼š
$L = \frac{d^2\Phi}{dA \cos \theta d\omega} = \frac{d^2\Phi}{dA_\perp d\omega}$ [W/(mÂ²Â·sr)]

å…¶ä¸­ $dA_\perp = dA \cos \theta$ æ˜¯å‚ç›´äºå…‰çº¿æ–¹å‘çš„æŠ•å½±é¢ç§¯ã€‚

è¾å°„ç‡æ˜¯æ¸²æŸ“ä¸­çš„åŸºæœ¬é‡ï¼Œå› ä¸ºï¼š
1. å®ƒåœ¨çœŸç©ºä¸­æ²¿å…‰çº¿ä¿æŒæ’å®šï¼ˆè¾å°„ç‡ä¸å˜æ€§å®šç†ï¼‰
2. å®ƒæ˜¯ç›¸æœºå’Œçœ¼ç›æµ‹é‡çš„é‡
3. æ‰€æœ‰å…¶ä»–è¾å°„åº¦é‡éƒ½å¯ä»¥ä»å®ƒå¯¼å‡º

**å…‰åº¦é‡ä¸è¾å°„åº¦é‡**ï¼šè™½ç„¶æˆ‘ä»¬å…³æ³¨è¾å°„åº¦é‡ï¼ˆç‰©ç†èƒ½é‡ï¼‰ï¼Œä½†ä¸ºäººç±»æ„ŸçŸ¥è¿›è¡Œæ¸²æŸ“æ—¶é€šå¸¸ä½¿ç”¨å…‰åº¦é‡ï¼š
- å…‰é€šé‡ [lm] = è¾å°„é€šé‡ [W] Ã— å…‰æ•ˆèƒ½
- äº®åº¦ [cd/mÂ²] = è¾å°„ç‡ Ã— æ˜è§†è§‰å“åº” V(Î»)
- CIEå…‰åº¦å‡½æ•° V(Î») åœ¨555 nmï¼ˆç»¿è‰²ï¼‰å¤„è¾¾åˆ°å³°å€¼

**å…‰è°±è¾å°„ç‡**ï¼šå®é™…ä¸Šï¼Œè¾å°„ç‡éšæ³¢é•¿å˜åŒ–ï¼š
$L(\mathbf{x}, \omega, \lambda)$ [W/(mÂ²Â·srÂ·nm)]

å¯¹äºæ¸²æŸ“ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ï¼š
- RGBè¿‘ä¼¼ï¼šå…‰è°±çš„3ä¸ªæ ·æœ¬
- å…‰è°±æ¸²æŸ“ï¼šNä¸ªæ³¢é•¿æ ·æœ¬ï¼ˆé€šå¸¸10-100ï¼‰
- ä¸»æ³¢é•¿ï¼šå…‰è°±çš„éšæœºé‡‡æ ·

**ç›¸å¹²ä¸éç›¸å¹²å åŠ **ï¼šè¾å°„åº¦é‡å‡è®¾éç›¸å¹²å…‰â€”â€”å¼ºåº¦ç›´æ¥ç›¸åŠ ã€‚å¯¹äºç›¸å¹²å…‰æºï¼ˆæ¿€å…‰ï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»è·Ÿè¸ªç›¸ä½å¹¶å åŠ å¤æŒ¯å¹…ï¼š
$I_{\text{total}} = |E_1 + E_2|^2 \neq |E_1|^2 + |E_2|^2$ ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰

### æ¸²æŸ“æ–¹ç¨‹

æ¸²æŸ“æ–¹ç¨‹ç”±Kajiyaï¼ˆ1986ï¼‰æå‡ºï¼Œæè¿°åœºæ™¯ä¸­å…‰çš„å¹³è¡¡åˆ†å¸ƒã€‚å®ƒæºäºåŠŸç‡å¹³è¡¡ï¼šåœ¨ä»»ä½•è¡¨é¢ç‚¹ï¼Œè¾“å‡ºåŠŸç‡ç­‰äºå‘å°„åŠŸç‡åŠ åå°„åŠŸç‡ã€‚

åœ¨å…·æœ‰æ³•çº¿ **n** çš„è¡¨é¢ç‚¹ **x** å¤„ï¼Œæ²¿æ–¹å‘ $\omega_o$ çš„å‡ºå°„è¾å°„ç‡ $L_o$ æ»¡è¶³ï¼š

$L_o(\mathbf{x}, \omega_o) = L_e(\mathbf{x}, \omega_o) + \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o) L_i(\mathbf{x}, \omega_i) (\omega_i \cdot \mathbf{n}) d\omega_i$

å…¶ä¸­ï¼š
- $L_e(\mathbf{x}, \omega_o)$ æ˜¯ä» **x** æ²¿æ–¹å‘ $\omega_o$ çš„å‘å°„è¾å°„ç‡
- $f_r(\mathbf{x}, \omega_i, \omega_o)$ æ˜¯BRDF [srâ»Â¹]
- $L_i(\mathbf{x}, \omega_i)$ æ˜¯åœ¨ **x** å¤„æ¥è‡ªæ–¹å‘ $\omega_i$ çš„å…¥å°„è¾å°„ç‡
- Î© æ˜¯ **x** ä¸Šæ–¹çš„åŠçƒï¼ˆå…¶ä¸­ $\omega \cdot \mathbf{n} > 0$ï¼‰
- $(\omega_i \cdot \mathbf{n}) = \cos \theta_i$ è€ƒè™‘äº†æŠ•å½±é¢ç§¯

ç§¯åˆ†è¡¨ç¤ºæ•£å°„ç§¯åˆ†â€”â€”å¯¹æ‰€æœ‰å…¥å°„æ–¹å‘çš„è´¡çŒ®æ±‚å’Œï¼Œç”±BRDFå’Œä½™å¼¦æŠ•å½±åŠ æƒã€‚

### èƒ½é‡å®ˆæ’ä¸æµ‹é‡æ–¹ç¨‹

èƒ½é‡å®ˆæ’çº¦æŸBRDFã€‚æ–¹å‘-åŠçƒåå°„ç‡ï¼ˆåç…§ç‡ï¼‰å¿…é¡»æ»¡è¶³ï¼š

$\rho(\omega_o) = \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o) \cos \theta_i d\omega_i \leq 1$ å¯¹æ‰€æœ‰ $\omega_o$

å¯¹äºæ— æŸè¡¨é¢ï¼Œç­‰å·æˆç«‹ã€‚ç™½ç‚‰æµ‹è¯•éªŒè¯èƒ½é‡å®ˆæ’ï¼šåœ¨å‡åŒ€ç…§æ˜ç¯å¢ƒä¸­ï¼ˆ$L_i = L_0$ï¼‰ï¼Œå°é—­è¡¨é¢æ—¢ä¸åº”è·å¾—ä¹Ÿä¸åº”å¤±å»èƒ½é‡ã€‚

**è¯¦ç»†èƒ½é‡å¹³è¡¡**ï¼šå¯¹äºè¡¨é¢å…ƒç´  dAï¼Œå®ˆæ’è¦æ±‚ï¼š

$\int_\Omega L_o(\mathbf{x}, \omega) \cos \theta d\omega dA = L_e dA + \int_\Omega L_i(\mathbf{x}, \omega) \cos \theta d\omega dA$

åœ¨çƒ­å¹³è¡¡çš„å°é—­ç³»ç»Ÿä¸­ï¼ŒåŸºå°”éœå¤«å®šå¾‹å°†å‘å°„ç‡ä¸å¸æ”¶ç‡å…³è”ï¼š
$\varepsilon(\lambda, \theta) = \alpha(\lambda, \theta) = 1 - \rho(\lambda, \theta)$

**æµ‹é‡æ–¹ç¨‹**ï¼šæµ‹é‡æ–¹ç¨‹å°†åœºæ™¯è¾å°„ç‡ä¸ä¼ æ„Ÿå™¨å“åº”è”ç³»èµ·æ¥ï¼š

$I_j = \int_A \int_\Omega W_j(\mathbf{x}, \omega) L(\mathbf{x}, \omega) \cos \theta d\omega dA$

å…¶ä¸­ $W_j(\mathbf{x}, \omega)$ æ˜¯åƒç´  j çš„é‡è¦æ€§ï¼ˆçµæ•åº¦ï¼‰å‡½æ•°ã€‚è¾å°„ç‡å’Œé‡è¦æ€§ä¹‹é—´çš„è¿™ç§å¯¹å¶æ€§ä½¿åŒå‘ç®—æ³•æˆä¸ºå¯èƒ½ã€‚

**é‡è¦æ€§ä¼ è¾“**ï¼šé‡è¦æ€§æ»¡è¶³ä¼´éšæ–¹ç¨‹ï¼š

$W(\mathbf{x}, \omega) = W_e(\mathbf{x}, \omega) + \int_\Omega f_r(\mathbf{x}, \omega, \omega') W(\mathbf{x}, \omega') \cos \theta' d\omega'$

è¿™ç§å¯¹ç§°æ€§å¯¼è‡´ï¼š
- åŒå‘è·¯å¾„è¿½è¸ª
- å…‰å­æ˜ å°„ï¼ˆæ­£å‘å…‰ï¼Œåå‘é‡è¦æ€§ï¼‰
- æ¢¯åº¦è®¡ç®—çš„ä¼´éšæ–¹æ³•

å¯¹äºé’ˆå­”ç›¸æœºï¼Œåƒç´  j ä»é’ˆå­”å¼ æˆç«‹ä½“è§’ $\Omega_j$ï¼š

$I_j = \int_{\Omega_j} L(\mathbf{x}_{\text{lens}}, \omega) \cos^4 \theta d\omega$

$\cos^4 \theta$ é¡¹è€ƒè™‘äº†ï¼š
- $\cos \theta$ï¼šæŠ•å½±é€é•œé¢ç§¯
- $\cos^3 \theta$ï¼šå¹³æ–¹åæ¯”è¡°å‡å’Œåƒç´ æŠ•å½±

**æœ‰é™å­”å¾„ç›¸æœº**ï¼šå¯¹äºå…·æœ‰å­”å¾„ $A_{\text{lens}}$ çš„çœŸå®ç›¸æœºï¼š

$I_j = \frac{1}{A_{\text{lens}}} \int_{A_{\text{lens}}} \int_{A_{\text{pixel}}} L(\mathbf{x}_{\text{lens}} \rightarrow \mathbf{x}_{\text{pixel}}) G(\mathbf{x}_{\text{lens}} \leftrightarrow \mathbf{x}_{\text{pixel}}) dA_{\text{pixel}} dA_{\text{lens}}$

è¿™å¯¼è‡´æ™¯æ·±æ•ˆæœå¹¶éœ€è¦ä»”ç»†çš„é‡‡æ ·ç­–ç•¥ã€‚

### ç®—å­å½¢å¼ä¸è¯ºä¼Šæ›¼çº§æ•°

æ¸²æŸ“æ–¹ç¨‹å…è®¸ä¼˜é›…çš„ç®—å­è¡¨è¿°ã€‚å®šä¹‰ä¼ è¾“ç®—å­ ğ’¯ï¼š

$(\mathcal{T}L)(\mathbf{x}, \omega) = \int_\Omega f_r(\mathbf{x}, \omega', \omega) L(\mathbf{x}, \omega') (\omega' \cdot \mathbf{n}) d\omega'$

åˆ™æ¸²æŸ“æ–¹ç¨‹å˜ä¸ºï¼š

$L = L_e + \mathcal{T}L$

è¿™æ˜¯ç¬¬äºŒç±»å¼—é›·å¾·éœå§†æ–¹ç¨‹ã€‚é€šè¿‡è¯ºä¼Šæ›¼çº§æ•°çš„è§£ï¼š

$L = (I - \mathcal{T})^{-1}L_e = \sum_{k=0}^\infty \mathcal{T}^k L_e = L_e + \mathcal{T}L_e + \mathcal{T}^2L_e + ...$

æ¯é¡¹éƒ½æœ‰ç‰©ç†æ„ä¹‰ï¼š
- $L_e$ï¼šç›´æ¥ç…§æ˜ï¼ˆä»…å‘å°„ï¼‰
- $\mathcal{T}L_e$ï¼šå•æ¬¡åå¼¹ç…§æ˜
- $\mathcal{T}^2L_e$ï¼šä¸¤æ¬¡åå¼¹ç…§æ˜
- $\mathcal{T}^k L_e$ï¼škæ¬¡åå¼¹ç…§æ˜

å½“ $||\mathcal{T}|| < 1$ æ—¶çº§æ•°æ”¶æ•›ï¼Œè¿™åœ¨æœ€å¤§åç…§ç‡ < 1 æ—¶å‘ç”Ÿã€‚è¿™ç§åˆ†è§£è‡ªç„¶å¯¼è‡´é‡‡æ ·è·¯å¾„é•¿åº¦é€’å¢çš„è·¯å¾„è¿½è¸ªç®—æ³•ã€‚

### ä¸‰ç‚¹å½¢å¼ä¸å‡ ä½•è€¦åˆ

æ¸²æŸ“æ–¹ç¨‹å¯ä»¥æ”¹å†™ä¸ºä¸‰ç‚¹å½¢å¼ï¼Œä½¿å‡ ä½•è€¦åˆæ˜ç¡®ï¼š

$L(\mathbf{x} \rightarrow \mathbf{x}') = L_e(\mathbf{x} \rightarrow \mathbf{x}') + \int_M f_r(\mathbf{x}'' \rightarrow \mathbf{x} \rightarrow \mathbf{x}') L(\mathbf{x}'' \rightarrow \mathbf{x}) G(\mathbf{x}'' \leftrightarrow \mathbf{x}) dA(\mathbf{x}'')$

å…¶ä¸­å‡ ä½•å› å­æ˜¯ï¼š

$G(\mathbf{x} \leftrightarrow \mathbf{x}') = V(\mathbf{x} \leftrightarrow \mathbf{x}') \frac{\cos \theta \cos \theta'}{||\mathbf{x} - \mathbf{x}'||^2}$

å…¶ä¸­ï¼š
- $V(\mathbf{x} \leftrightarrow \mathbf{x}')$ï¼šäºŒå…ƒå¯è§æ€§å‡½æ•°ï¼ˆç›¸äº’å¯è§ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰
- $\cos \theta, \cos \theta'$ï¼šè¡¨é¢æ³•çº¿ä¸è¿æ¥çº¿ä¹‹é—´çš„è§’åº¦
- $||\mathbf{x} - \mathbf{x}'||^2$ï¼šå¹³æ–¹åæ¯”è¡°å‡çš„å¹³æ–¹è·ç¦»

è¿™ç§å½¢å¼å¼ºè°ƒå…‰ä¼ è¾“è€¦åˆæ‰€æœ‰è¡¨é¢ç‚¹ï¼Œå¯¼è‡´è·¯å¾„ç§¯åˆ†è¡¨è¿°ã€‚

**å¯è§æ€§å¤æ‚æ€§**ï¼šå¯è§æ€§å‡½æ•° $V(\mathbf{x} \leftrightarrow \mathbf{x}')$ ä½¿æ¸²æŸ“æ–¹ç¨‹æˆä¸ºéçº¿æ€§å’Œéå±€éƒ¨çš„ï¼š
- ä¸è¿ç»­ï¼šåˆ›å»ºç¡¬é˜´å½±å’Œé®æŒ¡è¾¹ç•Œ
- è®¡ç®—æ˜‚è´µï¼šéœ€è¦å…‰çº¿-åœºæ™¯ç›¸äº¤
- è€¦åˆæ‰€æœ‰å‡ ä½•ï¼šä»»ä½•åœ°æ–¹çš„å˜åŒ–éƒ½ä¼šå½±å“æ‰€æœ‰åœ°æ–¹çš„å¯è§æ€§

**æ ¸å‡½æ•°æ€§è´¨**ï¼šä¼ è¾“æ ¸ $K(\mathbf{x}'' \rightarrow \mathbf{x}) = f_r G V$ å…·æœ‰é‡è¦æ€§è´¨ï¼š
- æ²¿ $\mathbf{x} = \mathbf{x}''$ å¥‡å¼‚ï¼ˆéœ€è¦ä»”ç»†æ­£åˆ™åŒ–ï¼‰
- åœ¨é®æŒ¡è¾¹ç•Œå¤„ä¸è¿ç»­
- æ»¡è¶³äº’æ˜“æ€§ï¼š$K(\mathbf{x} \rightarrow \mathbf{x}') = K(\mathbf{x}' \rightarrow \mathbf{x})$

**ä¸çƒ­æ–¹ç¨‹çš„è”ç³»**ï¼šæ²¡æœ‰å¯è§æ€§æ—¶ï¼Œæ¸²æŸ“æ–¹ç¨‹ç±»ä¼¼äºå…·æœ‰éå±€éƒ¨æ ¸çš„çƒ­æ–¹ç¨‹ã€‚è¿™ä¸ªç±»æ¯”æœ‰åŠ©äºç†è§£ï¼š
- å¤šé‡æ•£å°„çš„å¹³æ»‘æ€§è´¨
- å…‰å­¦åšä»‹è´¨çš„æ‰©æ•£è¿‘ä¼¼
- æœ‰é™å…ƒå’Œå¤šé‡ç½‘æ ¼æ±‚è§£æ–¹æ³•

## 1.2 åæ ‡ç³»ç»Ÿä¸å˜æ¢

### ä¸–ç•Œã€ç›¸æœºå’Œç‰©ä½“ç©ºé—´

æ¸²æŸ“ç®¡çº¿æ¶‰åŠåæ ‡ç³»ç»Ÿå±‚æ¬¡ç»“æ„ï¼Œæ¯ä¸ªéƒ½é’ˆå¯¹ç‰¹å®šè®¡ç®—è¿›è¡Œä¼˜åŒ–ï¼š

1. **ç‰©ä½“ç©ºé—´ï¼ˆæ¨¡å‹ç©ºé—´ï¼‰**ï¼šä»¥è§„èŒƒå½¢å¼å®šä¹‰çš„å‡ ä½•
   - åŸç‚¹é€šå¸¸åœ¨ç‰©ä½“ä¸­å¿ƒæˆ–åº•éƒ¨
   - è½´ä¸è‡ªç„¶å¯¹ç§°æ€§å¯¹é½
   - ç®€åŒ–å»ºæ¨¡å’ŒåŠ¨ç”»

2. **ä¸–ç•Œç©ºé—´**ï¼šç»Ÿä¸€çš„åœºæ™¯åæ ‡
   - æ‰€æœ‰ç‰©ä½“å˜æ¢åˆ°å…¬å…±æ¡†æ¶
   - å…‰ç…§å’Œç‰©ç†è®¡ç®—
   - å…‰çº¿-ç‰©ä½“ç›¸äº¤

3. **ç›¸æœºç©ºé—´ï¼ˆè§†å›¾ç©ºé—´ï¼‰**ï¼šä»¥è§‚å¯Ÿè€…ä¸ºä¸­å¿ƒçš„åæ ‡
   - åŸç‚¹åœ¨çœ¼ç‚¹
   - -zè½´æ²¿è§†çº¿æ–¹å‘ï¼ˆOpenGLçº¦å®šï¼‰
   - +zè¿›å…¥å±å¹•ï¼ˆDirectXçº¦å®šï¼‰
   - ç®€åŒ–æŠ•å½±å’Œå‰”é™¤

4. **è£å‰ªç©ºé—´**ï¼šæŠ•å½±åçš„é½æ¬¡åæ ‡
   - é€è§†é™¤æ³•å‰çš„4Dåæ ‡
   - è§†é”¥ä½“å˜ä¸º[-1,1]Â³ç«‹æ–¹ä½“ï¼ˆNDCï¼‰

5. **å±å¹•ç©ºé—´ï¼ˆå…‰æ …ç©ºé—´ï¼‰**ï¼šæœ€ç»ˆçš„2Då›¾åƒåæ ‡
   - æ•´æ•°åƒç´ åæ ‡
   - åŸç‚¹åœ¨å·¦ä¸Šè§’æˆ–å·¦ä¸‹è§’

### é½æ¬¡åæ ‡ä¸å˜æ¢

é½æ¬¡åæ ‡ç»Ÿä¸€äº†å¹³ç§»å’Œçº¿æ€§å˜æ¢ã€‚3Dç‚¹ **p** = (x, y, z) å˜ä¸º **pÌƒ** = (x, y, z, 1)ï¼Œè€Œå‘é‡ä½¿ç”¨ **á¹½** = (x, y, z, 0)ã€‚

ä¸€èˆ¬ä»¿å°„å˜æ¢çŸ©é˜µï¼š

$\mathbf{M} = \begin{bmatrix} \mathbf{A} & \mathbf{t} \\ \mathbf{0} & 1 \end{bmatrix}$

å…¶ä¸­ **A** æ˜¯3Ã—3çº¿æ€§éƒ¨åˆ†ï¼Œ**t** æ˜¯å¹³ç§»ã€‚å¸¸è§å˜æ¢ï¼š

**å¹³ç§» (tx, ty, tz)ï¼š**
$\begin{bmatrix} 1 & 0 & 0 & t_x \\ 0 & 1 & 0 & t_y \\ 0 & 0 & 1 & t_z \\ 0 & 0 & 0 & 1 \end{bmatrix}$

**ç»•è½´ **a** æ—‹è½¬è§’åº¦ Î¸ï¼š**
$\mathbf{R} = \cos \theta \mathbf{I} + (1 - \cos \theta) \mathbf{a}\mathbf{a}^T + \sin \theta [\mathbf{a}]_\times$

å…¶ä¸­ $[\mathbf{a}]_\times$ æ˜¯åå¯¹ç§°å‰ç§¯çŸ©é˜µã€‚

**ç¼©æ”¾ (sx, sy, sz)ï¼š**
$\begin{bmatrix} s_x & 0 & 0 & 0 \\ 0 & s_y & 0 & 0 \\ 0 & 0 & s_z & 0 \\ 0 & 0 & 0 & 1 \end{bmatrix}$

### æ³•çº¿å’Œåˆ‡çº¿å˜æ¢

æ³•çº¿å¿…é¡»å˜æ¢ä»¥ä¿æŒä¸è¡¨é¢å‚ç›´ã€‚ç»™å®šç‚¹çš„å˜æ¢ **M**ï¼š

$\mathbf{n}' = \frac{(\mathbf{M}^{-T})^{3Ã—3} \mathbf{n}}{||(\mathbf{M}^{-T})^{3Ã—3} \mathbf{n}||}$

è¯æ˜ï¼šå¯¹äºè¡¨é¢ä¸Šçš„åˆ‡çº¿ **t**ï¼Œ$\mathbf{n} \cdot \mathbf{t} = 0$ã€‚å˜æ¢åï¼š
$\mathbf{n}' \cdot \mathbf{t}' = (\mathbf{M}^{-T}\mathbf{n}) \cdot (\mathbf{M}\mathbf{t}) = \mathbf{n}^T \mathbf{M}^{-1} \mathbf{M} \mathbf{t} = \mathbf{n} \cdot \mathbf{t} = 0$

å¯¹äºæ­£äº¤æ ‡æ¶ {**t**, **b**, **n**}ï¼š
- æ­£å‘ï¼šå˜æ¢ **t** å’Œ **b**ï¼Œç„¶å $\mathbf{n} = \mathbf{t} \times \mathbf{b}$
- æˆ–å¦‚ä¸Šå˜æ¢ **n**ï¼Œç„¶åé‡å»ºæ ‡æ¶

**é¢ç§¯å’Œä½“ç§¯å…ƒç´ **ï¼šåœ¨å˜æ¢ **M** ä¸‹ï¼Œå¾®åˆ†å…ƒç´ ç¼©æ”¾ä¸ºï¼š
- é•¿åº¦ï¼š$dl' = ||\mathbf{M}\mathbf{v}|| dl$ï¼ˆå¯¹äºæ–¹å‘ **v**ï¼‰
- é¢ç§¯ï¼š$dA' = |\det(\mathbf{M})| ||(\mathbf{M}^{-T})\mathbf{n}|| dA$
- ä½“ç§¯ï¼š$dV' = |\det(\mathbf{M})| dV$

**éå‡åŒ€ç¼©æ”¾é—®é¢˜**ï¼šéå‡åŒ€ç¼©æ”¾ç ´åå„å‘åŒæ€§ï¼š
- çƒä½“ â†’ æ¤­çƒä½“
- å„å‘åŒæ€§BRDF â†’ å„å‘å¼‚æ€§BRDF
- éœ€è¦æ³¨æ„åŸºäºç‰©ç†çš„æè´¨

**æ‰‹æ€§ä¿æŒ**ï¼šå½“ $\det(\mathbf{M}) < 0$ æ—¶ï¼Œå˜æ¢ç¿»è½¬æ–¹å‘ï¼š
- å³æ‰‹ç³» â†’ å·¦æ‰‹ç³»åæ ‡ç³»ç»Ÿ
- æ³•çº¿æ–¹å‘å¿…é¡»ç¿»è½¬
- å¯¹ä¸€è‡´çš„æ­£é¢/èƒŒé¢åˆ¤å®šè‡³å…³é‡è¦

### çƒé¢å’Œç«‹ä½“è§’å‚æ•°åŒ–

çƒé¢åæ ‡ä¸ºæ–¹å‘æä¾›è‡ªç„¶å‚æ•°åŒ–ï¼š

$\omega = (\sin \theta \cos \phi, \sin \theta \sin \phi, \cos \theta)$

å…¶ä¸­ï¼š
- $\theta \in [0, \pi]$ï¼šä»+zè½´çš„æè§’
- $\phi \in [0, 2\pi]$ï¼šä»+xè½´çš„æ–¹ä½è§’

é›…å¯æ¯”ç»™å‡ºå¾®åˆ†ç«‹ä½“è§’ï¼š

$d\omega = \left|\frac{\partial(\omega_x, \omega_y)}{\partial(\theta, \phi)}\right| d\theta d\phi = \sin \theta d\theta d\phi$

åŠçƒæ€»ç«‹ä½“è§’ï¼š$\int_\Omega d\omega = 2\pi$

ç”¨äºé‡‡æ ·çš„æ›¿ä»£å‚æ•°åŒ–ï¼š

**åŒå¿ƒåœ†ç›˜æ˜ å°„**ï¼ˆShirley-Chiuï¼‰ï¼š
$(u, v) \in [-1, 1]^2 \rightarrow (r, \phi) \rightarrow (x, y)$ åœ¨å•ä½åœ†ç›˜ä¸Š

**å…«é¢ä½“æ˜ å°„**ï¼š
å•ä½çƒé¢ â†’ å…«é¢ä½“ â†’ å•ä½æ­£æ–¹å½¢
æ¯”çƒé¢åæ ‡æ›´å¥½åœ°ä¿æŒé¢ç§¯

### ç§¯åˆ†ä¸­çš„å˜é‡æ›¿æ¢

ç§¯åˆ†çš„ä¸€èˆ¬å˜é‡æ›¿æ¢å…¬å¼ï¼š

$\int_\Omega f(\mathbf{x}) d\mathbf{x} = \int_{\Omega'} f(\mathbf{x}(\mathbf{u})) \left|\det\left(\frac{\partial\mathbf{x}}{\partial\mathbf{u}}\right)\right| d\mathbf{u}$

å¯¹æ¸²æŸ“è‡³å…³é‡è¦ï¼š

**ç«‹ä½“è§’åˆ°é¢ç§¯**ï¼š
$\int_\Omega L(\mathbf{x}, \omega) \cos \theta d\omega = \int_A L(\mathbf{x}, \omega(\mathbf{x}')) G(\mathbf{x} \leftrightarrow \mathbf{x}') dA'$

å…¶ä¸­ $G(\mathbf{x} \leftrightarrow \mathbf{x}') = V(\mathbf{x} \leftrightarrow \mathbf{x}') \frac{\cos \theta \cos \theta'}{||\mathbf{x} - \mathbf{x}'||^2}$

**åŠçƒåˆ°åœ†ç›˜**ï¼ˆç”¨äºä½™å¼¦åŠ æƒé‡‡æ ·ï¼‰ï¼š
æ˜ å°„ $(\theta, \phi) \rightarrow (r, \phi)$ å…¶ä¸­ $r = \sin \theta$
åˆ™ $p(r, \phi) = p(\theta, \phi) \left|\frac{\partial(\theta, \phi)}{\partial(r, \phi)}\right| = \frac{p(\theta, \phi)}{\cos \theta}$

**æµ‹åº¦è®ºåŸºç¡€**ï¼šå˜é‡æ›¿æ¢å…¬å¼å…·æœ‰æµ‹åº¦è®ºåŸºç¡€ï¼š
- æ¨å‰æµ‹åº¦ï¼š$\mu'(A) = \mu(f^{-1}(A))$
- Radon-Nikodymå¯¼æ•°ç»™å‡ºé›…å¯æ¯”
- å¯¹ç†è§£è’™ç‰¹å¡æ´›æ”¶æ•›æ€§è‡³å…³é‡è¦

### æŠ•å½±å˜æ¢ä¸é€è§†

é€è§†æŠ•å½±çŸ©é˜µå°†è§†é”¥ä½“æ˜ å°„åˆ°è£å‰ªç©ºé—´ï¼š

$\mathbf{P} = \begin{bmatrix} 
n/r & 0 & 0 & 0 \\
0 & n/t & 0 & 0 \\
0 & 0 & -(f+n)/(f-n) & -2fn/(f-n) \\
0 & 0 & -1 & 0
\end{bmatrix}$

å…¶ä¸­ n, f æ˜¯è¿‘/è¿œå¹³é¢ï¼Œr, t æ˜¯è¿‘å¹³é¢çš„å³/é¡¶ã€‚

é€è§†é™¤æ³•åï¼š
- $x_{ndc} = x_{clip} / w_{clip} \in [-1, 1]$
- $y_{ndc} = y_{clip} / w_{clip} \in [-1, 1]$
- $z_{ndc} = z_{clip} / w_{clip} \in [-1, 1]$

é‡è¦æ€§è´¨ï¼š
- ç›´çº¿ä¿æŒä¸ºç›´çº¿ï¼ˆé™¤äº†é€šè¿‡çœ¼ç‚¹çš„ï¼‰
- å¹³é¢ä¿æŒä¸ºå¹³é¢
- æ·±åº¦ç²¾åº¦æ˜¯éçº¿æ€§çš„ï¼ˆè¿‘å¤„æ¯”è¿œå¤„ç²¾åº¦é«˜ï¼‰

### é‡å¿ƒåæ ‡ä¸æ’å€¼

å¯¹äºå…·æœ‰é¡¶ç‚¹ $\mathbf{v}_0, \mathbf{v}_1, \mathbf{v}_2$ çš„ä¸‰è§’å½¢ï¼Œé‡å¿ƒåæ ‡ (u, v, w) æ»¡è¶³ï¼š

$\mathbf{p} = u\mathbf{v}_0 + v\mathbf{v}_1 + w\mathbf{v}_2$

çº¦æŸæ¡ä»¶ $u + v + w = 1$ã€‚é€šè¿‡é¢ç§¯è®¡ç®—ï¼š

$u = \frac{\text{Area}(\mathbf{p}, \mathbf{v}_1, \mathbf{v}_2)}{\text{Area}(\mathbf{v}_0, \mathbf{v}_1, \mathbf{v}_2)}$

æ€§è´¨ï¼š
- $u, v, w \in [0, 1]$ å½“ä¸”ä»…å½“ **p** åœ¨ä¸‰è§’å½¢å†…
- çº¿æ€§æ’å€¼ï¼š$f(\mathbf{p}) = uf_0 + vf_1 + wf_2$
- é€è§†æ­£ç¡®çš„æ’å€¼éœ€è¦ 1/z æ ¡æ­£

é€è§†æ­£ç¡®çš„å±æ€§æ’å€¼ï¼š
1. åœ¨å±å¹•ç©ºé—´æ’å€¼ a/z, b/z, c/z å’Œ 1/z
2. æ¢å¤å±æ€§ï¼š$a = (a/z)/(1/z)$

### å¾®åˆ†å‡ ä½•ä¸å±€éƒ¨æ ‡æ¶

åœ¨æ¯ä¸ªè¡¨é¢ç‚¹ï¼Œæˆ‘ä»¬æ„å»ºç”¨äºç€è‰²è®¡ç®—çš„å±€éƒ¨æ ‡æ¶ï¼š

**åˆ‡ç©ºé—´åŸº**ï¼š
- **n**ï¼šè¡¨é¢æ³•çº¿ï¼ˆ$\frac{\partial\mathbf{p}}{\partial u} \times \frac{\partial\mathbf{p}}{\partial v}$ å½’ä¸€åŒ–ï¼‰
- **t**ï¼šåˆ‡çº¿ï¼ˆé€šå¸¸ $\frac{\partial\mathbf{p}}{\partial u}$ å½’ä¸€åŒ–ï¼‰
- **b**ï¼šå‰¯åˆ‡çº¿ï¼ˆ$\mathbf{n} \times \mathbf{t}$ï¼‰

**ç¬¬ä¸€åŸºæœ¬å½¢å¼**ï¼šåº¦é‡å¼ é‡æè¿°å±€éƒ¨è¡¨é¢å‡ ä½•ï¼š
$\mathbf{I} = \begin{bmatrix} E & F \\ F & G \end{bmatrix}$

å…¶ä¸­ï¼š
- $E = \frac{\partial\mathbf{p}}{\partial u} \cdot \frac{\partial\mathbf{p}}{\partial u}$
- $F = \frac{\partial\mathbf{p}}{\partial u} \cdot \frac{\partial\mathbf{p}}{\partial v}$
- $G = \frac{\partial\mathbf{p}}{\partial v} \cdot \frac{\partial\mathbf{p}}{\partial v}$

å¼§é•¿ï¼š$ds^2 = E du^2 + 2F du dv + G dv^2$
é¢ç§¯å…ƒç´ ï¼š$dA = \sqrt{EG - F^2} du dv$

**ç¬¬äºŒåŸºæœ¬å½¢å¼**ï¼šæè¿°è¡¨é¢æ›²ç‡ï¼š
$\mathbf{II} = \begin{bmatrix} e & f \\ f & g \end{bmatrix}$

å…¶ä¸­ $e = \mathbf{n} \cdot \frac{\partial^2\mathbf{p}}{\partial u^2}$ ç­‰ã€‚

ä¸»æ›²ç‡ $\kappa_1, \kappa_2$ æ˜¯ $\mathbf{II}\mathbf{I}^{-1}$ çš„ç‰¹å¾å€¼
- å¹³å‡æ›²ç‡ï¼š$H = (\kappa_1 + \kappa_2)/2$
- é«˜æ–¯æ›²ç‡ï¼š$K = \kappa_1\kappa_2$

**ä¸–ç•Œç©ºé—´çš„å˜æ¢**ï¼š
$\begin{bmatrix} \mathbf{t}_{world} \\ \mathbf{b}_{world} \\ \mathbf{n}_{world} \end{bmatrix} = \begin{bmatrix} t_x & t_y & t_z \\ b_x & b_y & b_z \\ n_x & n_y & n_z \end{bmatrix} \begin{bmatrix} \mathbf{t}_{local} \\ \mathbf{b}_{local} \\ \mathbf{n}_{local} \end{bmatrix}$

è¿™ä¸ªæ­£äº¤çŸ©é˜µå¯ä»¥é€šè¿‡è½¬ç½®æ±‚é€†ã€‚

**å„å‘å¼‚æ€§BRDFå‚æ•°åŒ–**ï¼š
è®¸å¤šBRDFä¾èµ–äºç›¸å¯¹äºåˆ‡çº¿çš„è§’åº¦ï¼š
- $\phi_h$ï¼šåŠå‘é‡åœ¨åˆ‡ç©ºé—´ä¸­çš„æ–¹ä½è§’
- èƒ½å¤Ÿå»ºæ¨¡æ‹‰ä¸é‡‘å±ã€ç»‡ç‰©ã€æ¯›å‘

**å¹³è¡Œä¼ è¾“**ï¼šåœ¨è¡¨é¢ä¸Šè¿½è¸ªå…‰çº¿æ—¶ï¼Œåˆ‡æ ‡æ¶å¿…é¡»å¹³è¡Œä¼ è¾“ï¼š
- ä¿æŒæ–¹å‘ä¸€è‡´æ€§
- ä¿ç•™å„å‘å¼‚æ€§å¤–è§‚
- ä¸å…‰å­¦ä¸­çš„å‡ ä½•ç›¸ä½ç›¸å…³

## 1.3 BRDFã€BSDFå’ŒBSSRDF

### åŒå‘åå°„åˆ†å¸ƒå‡½æ•°ï¼ˆBRDFï¼‰

BRDF $f_r$ é‡åŒ–å…¥å°„è¾ç…§åº¦å’Œåå°„è¾å°„ç‡ä¹‹é—´çš„å¾®åˆ†å…³ç³»ï¼š

$f_r(\mathbf{x}, \omega_i, \omega_o) = \frac{dL_o(\mathbf{x}, \omega_o)}{dE_i(\mathbf{x}, \omega_i)} = \frac{dL_o(\mathbf{x}, \omega_o)}{L_i(\mathbf{x}, \omega_i) \cos \theta_i d\omega_i}$ [srâ»Â¹]

ç‰©ç†ä¸Šï¼Œå®ƒè¡¨ç¤ºæ¥è‡ªæ–¹å‘ $\omega_i$ çš„å…‰å­æ•£å°„åˆ°æ–¹å‘ $\omega_o$ çš„æ¦‚ç‡å¯†åº¦ï¼ˆå½’ä¸€åŒ–åï¼‰ã€‚

BRDFå¯ä»¥åˆ†è§£ä¸ºåˆ†é‡ï¼š
$f_r = f_d + f_s + f_g + ...$

å…¶ä¸­ $f_d$ æ˜¯æ¼«åå°„ï¼Œ$f_s$ æ˜¯é•œé¢åå°„ï¼Œ$f_g$ æ˜¯å…‰æ³½åå°„ç­‰ã€‚è¿™ç§åˆ†è§£æœ‰åŠ©äºé‡è¦æ€§é‡‡æ ·ã€‚

### BRDFåŸºæœ¬æ€§è´¨

**äº¥å§†éœå…¹äº’æ˜“æ€§ï¼š**
$f_r(\mathbf{x}, \omega_i, \omega_o) = f_r(\mathbf{x}, \omega_o, \omega_i)$

è¿™æºè‡ªéº¦å…‹æ–¯éŸ¦æ–¹ç¨‹çš„æ—¶é—´åæ¼”å¯¹ç§°æ€§å’Œç»†è‡´å¹³è¡¡åŸç†ã€‚å®ƒä½¿åŒå‘è·¯å¾„è¿½è¸ªå’Œå…‰å­æ˜ å°„æˆä¸ºå¯èƒ½ã€‚

**èƒ½é‡å®ˆæ’ï¼š**
æ–¹å‘-åŠçƒåå°„ç‡å¿…é¡»æ»¡è¶³ï¼š

$\rho(\omega_i) = \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o) \cos \theta_o d\omega_o \leq 1$ å¯¹æ‰€æœ‰ $\omega_i$

å¯¹äºèƒ½é‡å®ˆæ’çš„BRDFï¼Œå½“å¸æ”¶ä¸ºé›¶æ—¶ç­‰å·æˆç«‹ã€‚åŠçƒ-åŠçƒåå°„ç‡ï¼š

$\rho_{hh} = \frac{1}{\pi} \int_\Omega \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o) \cos \theta_i \cos \theta_o d\omega_i d\omega_o \leq 1$

**éè´Ÿæ€§ï¼š**
$f_r(\mathbf{x}, \omega_i, \omega_o) \geq 0$

è´Ÿå€¼å°†æ„å‘³ç€ä¾èµ–äºå‡ºå°„æ–¹å‘çš„èƒ½é‡å¸æ”¶ï¼Œè¿åå› æœæ€§ã€‚

**å¯æµ‹æ€§å’Œå¯ç§¯æ€§ï¼š**
å¯¹äºè’™ç‰¹å¡æ´›ç§¯åˆ†æ”¶æ•›ï¼š
$f_r \in L^2(\Omega \times \Omega)$ ï¼ˆå¹³æ–¹å¯ç§¯ï¼‰

### ç»å…¸BRDFæ¨¡å‹

**æœ—ä¼¯ï¼ˆå®Œå…¨æ¼«åå°„ï¼‰ï¼š**
$f_r = \frac{\rho_d}{\pi}$

å…¶ä¸­ $\rho_d \in [0, 1]$ æ˜¯æ¼«åå°„ç‡ã€‚æ„é€ ä¸Šèƒ½é‡å®ˆæ’ã€‚

**Phongæ¨¡å‹ï¼š**
$f_r = \frac{\rho_d}{\pi} + \rho_s \frac{n+2}{2\pi} (\mathbf{r} \cdot \omega_o)^n$

å…¶ä¸­ $\mathbf{r} = 2(\mathbf{n} \cdot \omega_i)\mathbf{n} - \omega_i$ æ˜¯åå°„æ–¹å‘ã€‚ä¸æ»¡è¶³äº’æ˜“æ€§ï¼

**Blinn-Phongï¼ˆäº’æ˜“ï¼‰ï¼š**
$f_r = \frac{\rho_d}{\pi} + \rho_s \frac{n+2}{8\pi} \frac{(\mathbf{n} \cdot \mathbf{h})^n}{\max(\cos \theta_i, \cos \theta_o)}$

å…¶ä¸­ $\mathbf{h} = \frac{\omega_i + \omega_o}{||\omega_i + \omega_o||}$ æ˜¯åŠå‘é‡ã€‚

**Cook-Torranceå¾®é¢å…ƒæ¨¡å‹ï¼š**
$f_r = \frac{\rho_d}{\pi} + \frac{D(\mathbf{h})G(\omega_i, \omega_o)F(\omega_i, \mathbf{h})}{4 \cos \theta_i \cos \theta_o}$

å…¶ä¸­ï¼š
- $D(\mathbf{h})$ï¼šæ³•çº¿åˆ†å¸ƒå‡½æ•°ï¼ˆå¦‚GGXï¼‰
- $G(\omega_i, \omega_o)$ï¼šå‡ ä½•è¡°å‡ï¼ˆé®è”½/é˜´å½±ï¼‰
- $F(\omega_i, \mathbf{h})$ï¼šè²æ¶…å°”åå°„ç‡

### æ‰©å±•åˆ°BSDF

åŒå‘æ•£å°„åˆ†å¸ƒå‡½æ•°ï¼ˆBSDFï¼‰ç»Ÿä¸€äº†åå°„å’Œé€å°„ï¼š

$f_s(\mathbf{x}, \omega_i, \omega_o) = \begin{cases}
f_r(\mathbf{x}, \omega_i, \omega_o) & \text{å¦‚æœ } \omega_i \cdot \mathbf{n} \text{ å’Œ } \omega_o \cdot \mathbf{n} \text{ åŒå·} \\
f_t(\mathbf{x}, \omega_i, \omega_o) & \text{å¦‚æœ } \omega_i \cdot \mathbf{n} \text{ å’Œ } \omega_o \cdot \mathbf{n} \text{ å¼‚å·}
\end{cases}$

å¯¹äºç”µä»‹è´¨ç•Œé¢ï¼ˆå¦‚ç»ç’ƒï¼‰ï¼Œæ–¯æ¶…å°”å®šå¾‹æ§åˆ¶æŠ˜å°„ï¼š
$n_i \sin \theta_i = n_o \sin \theta_o$

è²æ¶…å°”æ–¹ç¨‹ç¡®å®šåå°„/é€å°„æ¦‚ç‡ï¼š
$F_r = \left(\frac{n_i \cos \theta_i - n_o \cos \theta_o}{n_i \cos \theta_i + n_o \cos \theta_o}\right)^2$ ï¼ˆsåæŒ¯ï¼‰

**BTDFçš„å¹¿ä¹‰äº’æ˜“æ€§ï¼š**
ç”±äºç•Œé¢ä¸Šçš„è¾å°„ç‡å‹ç¼©/æ‰©å±•ï¼š

$n_i^2 f_t(\mathbf{x}, \omega_i, \omega_o) = n_o^2 f_t(\mathbf{x}, \omega_o, \omega_i)$

è¿™è§£é‡Šäº†è¾å°„ç‡ $L/n^2$ ä¸å˜ä¸­çš„ $n^2$ å› å­ã€‚

### æ¬¡è¡¨é¢æ•£å°„çš„BSSRDF

åŒå‘æ•£å°„è¡¨é¢åå°„åˆ†å¸ƒå‡½æ•°å°†BRDFæ¨å¹¿åˆ°éå±€éƒ¨ä¼ è¾“ï¼š

$S(\mathbf{x}_i, \omega_i, \mathbf{x}_o, \omega_o) = \frac{dL_o(\mathbf{x}_o, \omega_o)}{d\Phi_i(\mathbf{x}_i, \omega_i)}$ [mâ»Â²srâ»Â¹]

ä¸BRDFçš„å…³é”®åŒºåˆ«ï¼š
- è€¦åˆä¸åŒçš„è¡¨é¢ç‚¹
- å•ä½åŒ…å«é€†é¢ç§¯
- ä¸å†æ˜¯çº¯æè´¨å±æ€§ï¼ˆä¾èµ–äºå‡ ä½•ï¼‰

å¸¦BSSRDFçš„æ¸²æŸ“æ–¹ç¨‹ï¼š

$L_o(\mathbf{x}_o, \omega_o) = L_e(\mathbf{x}_o, \omega_o) + \int_A \int_\Omega S(\mathbf{x}_i, \omega_i, \mathbf{x}_o, \omega_o) L_i(\mathbf{x}_i, \omega_i) \cos \theta_i d\omega_i dA_i$

**æ‰©æ•£è¿‘ä¼¼ï¼š**
å¯¹äºé«˜æ•£å°„ä»‹è´¨ï¼ŒBSSRDFå¯ä»¥è¿‘ä¼¼ä¸ºï¼š

$S(\mathbf{x}_i, \omega_i, \mathbf{x}_o, \omega_o) \approx \frac{1}{\pi}F_t(\omega_i)R(||\mathbf{x}_i - \mathbf{x}_o||)F_t(\omega_o)$

å…¶ä¸­ $R(r)$ æ˜¯æ‰©æ•£è½®å»“ï¼Œ$F_t$ æ˜¯è²æ¶…å°”é€å°„ç‡ã€‚

### æ•°å­¦çº¦æŸä¸ç‰©ç†åˆç†æ€§

ç‰©ç†æœ‰æ•ˆçš„BRDFå¿…é¡»æ»¡è¶³ï¼š

1. **äº’æ˜“æ€§**ï¼š$f_r(\mathbf{x}, \omega_i, \omega_o) = f_r(\mathbf{x}, \omega_o, \omega_i)$
   - æµ‹è¯•ï¼šäº¤æ¢å…‰æºå’Œç›¸æœºæ¸²æŸ“åœºæ™¯

2. **èƒ½é‡å®ˆæ’**ï¼š$\forall \omega_i: \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o) \cos \theta_o d\omega_o \leq 1$
   - æµ‹è¯•ï¼šç™½ç‚‰æµ‹è¯•ï¼ˆå‡åŒ€ç…§æ˜ï¼‰

3. **éè´Ÿæ€§**ï¼š$f_r(\mathbf{x}, \omega_i, \omega_o) \geq 0$
   - è¿åä¼šå¯¼è‡´èƒ½é‡å¸æ”¶å¼‚å¸¸

4. **å¹³æ»‘æ€§**ï¼š$f_r$ åº”è¯¥æ˜¯ $C^0$ è¿ç»­çš„ï¼ˆ$C^1$ æ›´å¥½ï¼‰
   - ä¸è¿ç»­æ€§å¯¼è‡´é‡‡æ ·å›°éš¾

5. **è²æ¶…å°”è¡Œä¸º**ï¼šå¯¹äºå…‰æ»‘è¡¨é¢ï¼Œå½“ $\theta \rightarrow \pi/2$ æ—¶ $f_r \rightarrow 1$
   - æ‰€æœ‰è¡¨é¢åœ¨æ å°„è§’åº¦éƒ½å˜æˆé•œé¢

### å„å‘å¼‚æ€§BRDF

å¯¹äºå…·æœ‰æ–¹å‘ç»“æ„çš„ææ–™ï¼ˆæ‹‰ä¸é‡‘å±ã€ç»‡ç‰©ã€æ¯›å‘ï¼‰ï¼ŒBRDFä¾èµ–äºæ–¹ä½è§’ï¼š

$f_r(\mathbf{x}, \omega_i, \omega_o, \phi)$

å…¶ä¸­ $\phi$ æ˜¯åŠå‘é‡æŠ•å½±ä¸åˆ‡çº¿æ–¹å‘ä¹‹é—´çš„è§’åº¦ã€‚

**Wardå„å‘å¼‚æ€§æ¨¡å‹ï¼š**
$f_r = \frac{\rho_d}{\pi} + \frac{\rho_s \exp\left(-\tan^2\theta_h\left(\frac{\cos^2\phi}{\alpha_x^2} + \frac{\sin^2\phi}{\alpha_y^2}\right)\right)}{4\pi \alpha_x \alpha_y \sqrt{\cos \theta_i \cos \theta_o}}$

å…¶ä¸­ $\alpha_x, \alpha_y$ æ§åˆ¶å„å‘å¼‚æ€§ç²—ç³™åº¦ã€‚

### ç©ºé—´å˜åŒ–BRDFï¼ˆSVBRDFï¼‰

çœŸå®ææ–™è¡¨ç°å‡ºç©ºé—´å˜åŒ–ï¼š
$f_r(\mathbf{x}, \omega_i, \omega_o) = f_r(u, v, \omega_i, \omega_o)$

å…¶ä¸­ $(u, v)$ æ˜¯çº¹ç†åæ ‡ã€‚è¿™ä½¿å¾—ä»¥ä¸‹æˆä¸ºå¯èƒ½ï¼š
- æè´¨å±æ€§çš„çº¹ç†æ˜ å°„
- æµ‹é‡çš„BRDFæ•°æ®ï¼ˆBTF - åŒå‘çº¹ç†å‡½æ•°ï¼‰
- è¿‡ç¨‹åŒ–æè´¨å˜åŒ–

## 1.4 æ¸²æŸ“ä¸­çš„è’™ç‰¹å¡æ´›ç§¯åˆ†

### æœŸæœ›å€¼ä¸æ–¹å·®

è’™ç‰¹å¡æ´›ç§¯åˆ†ä½¿ç”¨éšæœºé‡‡æ ·ä¼°è®¡ç§¯åˆ†ï¼š

$I = \int_\Omega f(\mathbf{x}) d\mathbf{x} \approx \frac{1}{N} \sum_{i=1}^N \frac{f(\mathbf{X}_i)}{p(\mathbf{X}_i)}$

å…¶ä¸­ $\mathbf{X}_i \sim p(\mathbf{x})$ æ˜¯æ¥è‡ªæ¦‚ç‡å¯†åº¦ $p$ çš„æ ·æœ¬ã€‚

ä¼°è®¡å™¨æ˜¯æ— åçš„ï¼š$E[\hat{I}] = I$

æ–¹å·®æ˜¯ï¼š
$\text{Var}[\hat{I}] = \frac{1}{N} \int_\Omega \left(\frac{f(\mathbf{x})}{p(\mathbf{x})} - I\right)^2 p(\mathbf{x}) d\mathbf{x}$

### é‡è¦æ€§é‡‡æ ·

æœ€ä¼˜é‡‡æ ·é€šè¿‡åŒ¹é… $p$ å’Œ $|f|$ æ¥æœ€å°åŒ–æ–¹å·®ï¼š

$p^*(\mathbf{x}) = \frac{|f(\mathbf{x})|}{\int_\Omega |f(\mathbf{x})| d\mathbf{x}}$

å¯¹äºæ¸²æŸ“æ–¹ç¨‹ï¼Œå¥½çš„é‡‡æ ·ç­–ç•¥åŒ…æ‹¬ï¼š
- BRDFé‡‡æ ·ï¼š$p(\omega) \propto f_r(\omega_i, \omega_o)$
- å…‰æºé‡‡æ ·ï¼š$p(\omega) \propto L_e$
- ä½™å¼¦é‡‡æ ·ï¼š$p(\omega) \propto \cos \theta$

### å¤šé‡é‡è¦æ€§é‡‡æ ·ï¼ˆMISï¼‰

å½“æœ‰å¤šä¸ªé‡‡æ ·ç­–ç•¥å¯ç”¨æ—¶ï¼ŒMISå°†å®ƒä»¬æœ€ä¼˜åœ°ç»„åˆï¼š

$\hat{I} = \sum_{i=1}^{n_f} w_f(\mathbf{X}_{f,i}) \frac{f(\mathbf{X}_{f,i})}{p_f(\mathbf{X}_{f,i})} + \sum_{j=1}^{n_g} w_g(\mathbf{X}_{g,j}) \frac{f(\mathbf{X}_{g,j})}{p_g(\mathbf{X}_{g,j})}$

å¹³è¡¡å¯å‘å¼æä¾›å¥½çš„æƒé‡ï¼š
$w_f(\mathbf{x}) = \frac{n_f p_f(\mathbf{x})}{n_f p_f(\mathbf{x}) + n_g p_g(\mathbf{x})}$

### ä¿„ç½—æ–¯è½®ç›˜èµŒ

ä¸ºäº†ç”¨æœ‰é™è®¡ç®—åˆ›å»ºæ— åä¼°è®¡å™¨ï¼Œä¿„ç½—æ–¯è½®ç›˜èµŒéšæœºç»ˆæ­¢è·¯å¾„ï¼š

$L'_i = \begin{cases}
L_i/q & \text{ä»¥æ¦‚ç‡ } q \\
0 & \text{ä»¥æ¦‚ç‡ } 1-q
\end{cases}$

è¿™ä¿æŒ $E[L'_i] = L_i$ åŒæ—¶é™åˆ¶è®¡ç®—é‡ã€‚

### æ”¶æ•›é€Ÿç‡ä¸è¯¯å·®ç•Œé™

è’™ç‰¹å¡æ´›æ”¶æ•›éµå¾ªä¸­å¿ƒæé™å®šç†ï¼š

$P(|\hat{I} - I| \leq \varepsilon) \approx 2\Phi(\varepsilon\sqrt{N}/\sigma) - 1$

å…¶ä¸­ $\Phi$ æ˜¯æ­£æ€åˆ†å¸ƒCDFï¼Œ$\sigma^2$ æ˜¯æ–¹å·®ã€‚è¯¯å·®ä»¥ $O(1/\sqrt{N})$ é€’å‡ï¼Œä¸ç»´åº¦æ— å…³â€”â€”è¿™å¯¹é«˜ç»´å…‰ä¼ è¾“è‡³å…³é‡è¦ã€‚

## 1.5 è·¯å¾„ç§¯åˆ†è¡¨è¿°

### å…‰ä¼ è¾“ä½œä¸ºè·¯å¾„ç§¯åˆ†

æˆ‘ä»¬å¯ä»¥å°†æ¸²æŸ“æ–¹ç¨‹é‡æ–°è¡¨è¿°ä¸ºå¯¹æ‰€æœ‰å¯èƒ½å…‰è·¯å¾„çš„ç§¯åˆ†ã€‚é•¿åº¦ä¸ºkçš„è·¯å¾„æ˜¯ï¼š

$\bar{\mathbf{x}} = \mathbf{x}_0\mathbf{x}_1...\mathbf{x}_k$

å…¶ä¸­ $\mathbf{x}_0$ åœ¨å…‰æºä¸Šï¼Œ$\mathbf{x}_k$ åœ¨ç›¸æœºä¼ æ„Ÿå™¨ä¸Šã€‚

### è·¯å¾„ç©ºé—´ä¸æµ‹åº¦

è·¯å¾„ç©ºé—´ $\bar{\Omega}_k$ åŒ…å«æ‰€æœ‰é•¿åº¦ä¸ºkçš„æœ‰æ•ˆè·¯å¾„ã€‚è·¯å¾„çš„æµ‹åº¦æ˜¯ï¼š

$d\mu(\bar{\mathbf{x}}) = dA(\mathbf{x}_0) \prod_{i=1}^{k} dA(\mathbf{x}_i)$

è·¯å¾„çš„è´¡çŒ®æ˜¯ï¼š

$f(\bar{\mathbf{x}}) = L_e(\mathbf{x}_0 \rightarrow \mathbf{x}_1) \left(\prod_{i=1}^{k-1} f_s(\mathbf{x}_{i-1} \rightarrow \mathbf{x}_i \rightarrow \mathbf{x}_{i+1}) G(\mathbf{x}_i \leftrightarrow \mathbf{x}_{i+1})\right) W(\mathbf{x}_{k-1} \rightarrow \mathbf{x}_k)$

å…¶ä¸­Gæ˜¯å‡ ä½•å› å­ï¼š

$G(\mathbf{x} \leftrightarrow \mathbf{x}') = V(\mathbf{x} \leftrightarrow \mathbf{x}') \frac{\cos \theta \cos \theta'}{||\mathbf{x} - \mathbf{x}'||^2}$

### ä¸è´¹æ›¼è·¯å¾„ç§¯åˆ†çš„è”ç³»

è·¯å¾„ç§¯åˆ†è¡¨è¿°ç±»ä¼¼äºè´¹æ›¼å¯¹é‡å­åŠ›å­¦çš„æ–¹æ³•ï¼š

$I = \sum_{k=2}^\infty \int_{\bar{\Omega}_k} f(\bar{\mathbf{x}}) d\mu(\bar{\mathbf{x}})$

è¿™ä¸ªå¯¹æ‰€æœ‰è·¯å¾„é•¿åº¦çš„æ— é™å’Œæ•è·äº†å…¨å±€å…‰ç…§ã€‚æ¯ä¸€é¡¹ä»£è¡¨k-1æ¬¡åå¼¹çš„è·¯å¾„ã€‚

### é€’å½’è¡¨è¿°ä¸è¯ºä¼Šæ›¼çº§æ•°

ç‚¹ä¸Šçš„å€¼æ»¡è¶³é€’å½’å…³ç³»ï¼š

$L(\mathbf{x}, \omega) = L_e(\mathbf{x}, \omega) + \int_M f_s(\mathbf{y} \rightarrow \mathbf{x} \rightarrow \omega) L(\mathbf{y}, \mathbf{x} - \mathbf{y}) G(\mathbf{y} \leftrightarrow \mathbf{x}) dA(\mathbf{y})$

è¿™å¯¼è‡´è¯ºä¼Šæ›¼çº§æ•°è§£ï¼š

$L = L^{(0)} + L^{(1)} + L^{(2)} + ...$

å…¶ä¸­ $L^{(k)}$ ä»£è¡¨kæ¬¡åå¼¹ç…§æ˜ã€‚

### ä½“ç§¯æ¸²æŸ“æ–¹ç¨‹é¢„è§ˆ

è·¯å¾„ç§¯åˆ†è‡ªç„¶æ‰©å±•åˆ°å‚ä¸ä»‹è´¨ã€‚å¯¹äºå…·æœ‰å¸æ”¶ $\sigma_a$ã€æ•£å°„ $\sigma_s$ å’Œç›¸ä½å‡½æ•° $p$ çš„ä½“ç§¯ï¼š

$L(\mathbf{x}, \omega) = \int_0^\infty T(0,t) \left[\sigma_a L_e + \sigma_s \int_{S^2} p(\omega', \omega) L(\mathbf{x}+t\omega, \omega') d\omega'\right] dt + T(0,\infty) L_\infty$

å…¶ä¸­ $T(s,t) = \exp\left(-\int_s^t \sigma_t(\mathbf{x}+u\omega) du\right)$ æ˜¯é€å°„ç‡ã€‚

è¿™ä¸ªç»Ÿä¸€çš„è¡¨è¿°å°†åœ¨åç»­ç« èŠ‚ä¸­è¿æ¥æ‰€æœ‰æ¸²æŸ“æ–¹æ³•ã€‚

## æœ¬ç« å°ç»“

æœ¬ç« é€šè¿‡å‡ ä½•å…‰å­¦å»ºç«‹äº†è®¡ç®—æœºå›¾å½¢å­¦çš„æ•°å­¦åŸºç¡€ï¼š

1. **æ¸²æŸ“æ–¹ç¨‹** $L_o = L_e + \int f_r L_i \cos \theta d\omega$ æ§åˆ¶å…‰ä¼ è¾“
2. **åæ ‡å˜æ¢** åœ¨æ­£ç¡®åº”ç”¨æ—¶ä¿æŒè¾å°„åº¦é‡
3. **BRDF** å¿…é¡»æ»¡è¶³äº’æ˜“æ€§ã€èƒ½é‡å®ˆæ’å’Œéè´Ÿæ€§
4. **è’™ç‰¹å¡æ´›æ–¹æ³•** ä»¥ $O(1/\sqrt{N})$ æ”¶æ•›ç‡æ±‚è§£é«˜ç»´ç§¯åˆ†
5. **è·¯å¾„ç§¯åˆ†** å°†å…‰ä¼ è¾“ç»Ÿä¸€ä¸ºå¯¹æ‰€æœ‰å¯èƒ½è·¯å¾„çš„ç§¯åˆ†

è¿™äº›æ¦‚å¿µæ„æˆäº†æ‰€æœ‰æ¸²æŸ“ç®—æ³•çš„åŸºç¡€ã€‚è·¯å¾„ç§¯åˆ†è¡¨è¿°ç‰¹åˆ«ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†åŸºäºç‚¹çš„ã€åŸºäºå›¾åƒçš„å’Œç¥ç»æ¸²æŸ“æ–¹æ³•ç»Ÿä¸€å¤„ç†ä¸ºè§£å†³åŒä¸€åŸºæœ¬æ–¹ç¨‹çš„ä¸åŒæ–¹æ³•ã€‚

## ç»ƒä¹ é¢˜

### ç»ƒä¹  1.1ï¼šæ²¿å…‰çº¿çš„è¾å°„ç‡
Prove that radiance remains constant along a ray in vacuum. Start from the definition of radiance and use the inverse square law.

**Hint:** Consider two differential areas dAâ‚ and dAâ‚‚ along the ray and show that Lâ‚ = Lâ‚‚.

<details>
<summary>Solution</summary>

Consider differential areas dAâ‚ and dAâ‚‚ at distances râ‚ and râ‚‚ along a ray. The solid angles subtended are:

dÏ‰â‚ = dAâ‚‚ cos Î¸â‚‚ / râ‚â‚‚Â²
dÏ‰â‚‚ = dAâ‚ cos Î¸â‚ / râ‚â‚‚Â²

The flux leaving dAâ‚ toward dAâ‚‚ is:
dÎ¦ = Lâ‚ dAâ‚ cos Î¸â‚ dÏ‰â‚ = Lâ‚ dAâ‚ cos Î¸â‚ dAâ‚‚ cos Î¸â‚‚ / râ‚â‚‚Â²

By energy conservation, this equals the flux arriving at dAâ‚‚:
dÎ¦ = Lâ‚‚ dAâ‚‚ cos Î¸â‚‚ dÏ‰â‚‚ = Lâ‚‚ dAâ‚‚ cos Î¸â‚‚ dAâ‚ cos Î¸â‚ / râ‚â‚‚Â²

Therefore Lâ‚ = Lâ‚‚, proving radiance invariance.
</details>

### Exercise 1.2: BRDF Energy Conservation
Prove that a Lambertian BRDF f_r = Ï/Ï€ satisfies energy conservation for any albedo Ï â‰¤ 1.

**Hint:** Integrate over the hemisphere using spherical coordinates.

<details>
<summary>Solution</summary>

For Lambertian BRDF f_r = Ï/Ï€, the directional-hemispherical reflectance is:

âˆ«_Î© f_r cos Î¸_o dÏ‰_o = (Ï/Ï€) âˆ«â‚€^{2Ï€} âˆ«â‚€^{Ï€/2} cos Î¸ sin Î¸ dÎ¸ dÏ†

= (Ï/Ï€) Â· 2Ï€ Â· âˆ«â‚€^{Ï€/2} cos Î¸ sin Î¸ dÎ¸

= (Ï/Ï€) Â· 2Ï€ Â· [sinÂ² Î¸/2]â‚€^{Ï€/2}

= (Ï/Ï€) Â· 2Ï€ Â· (1/2) = Ï

Since Ï â‰¤ 1, energy conservation is satisfied.
</details>

### Exercise 1.3: Monte Carlo Variance
Derive the optimal importance sampling distribution for estimating âˆ«â‚€Â¹ âˆšx dx and calculate the resulting variance.

**Hint:** The optimal PDF is proportional to |f(x)|.

<details>
<summary>Solution</summary>

For f(x) = âˆšx on [0,1], the optimal PDF is:

p*(x) = âˆšx / âˆ«â‚€Â¹ âˆšx dx = âˆšx / (2/3) = (3/2)âˆšx

To sample: X = Fâ»Â¹(U) where F(x) = âˆ«â‚€Ë£ (3/2)âˆšt dt = x^{3/2}

Therefore X = U^{2/3}

With this sampling, the estimator becomes:
f(X)/p*(X) = âˆšX / ((3/2)âˆšX) = 2/3

Since the estimator is constant, the variance is 0â€”perfect importance sampling eliminates variance.
</details>

### Exercise 1.4: Path Integral Convergence (Challenge)
Show that the Neumann series for the rendering equation converges when the maximum albedo in the scene is less than 1.

**Hint:** Use the operator norm ||ğ’¯|| â‰¤ Ï_max < 1.

<details>
<summary>Solution</summary>

The transport operator ğ’¯ satisfies:

||(ğ’¯L)||_âˆ â‰¤ Ï_max ||L||_âˆ

where Ï_max = max_{x,Ï‰} âˆ«_Î© f_r(x,Ï‰',Ï‰) cos Î¸' dÏ‰' < 1

By induction: ||ğ’¯^k L_e||_âˆ â‰¤ Ï_max^k ||L_e||_âˆ

The Neumann series converges:
||âˆ‘_{k=0}^âˆ ğ’¯^k L_e||_âˆ â‰¤ âˆ‘_{k=0}^âˆ Ï_max^k ||L_e||_âˆ = ||L_e||_âˆ/(1-Ï_max)

This proves convergence for Ï_max < 1.
</details>

### Exercise 1.5: Coordinate Transform Jacobian
Derive the Jacobian for converting the rendering equation from integration over solid angle to integration over surface area.

**Hint:** Start with dÏ‰ = dA cos Î¸'/rÂ².

<details>
<summary>Solution</summary>

Given points x and x' with connecting vector r = x' - x:

dÏ‰ = dA' cos Î¸' / ||r||Â²

The rendering equation becomes:

L_o(x,Ï‰_o) = L_e(x,Ï‰_o) + âˆ«_M f_r(x,Ï‰(x'),Ï‰_o) L_i(x',âˆ’Ï‰(x')) V(xâ†”x') (cos Î¸ cos Î¸')/||r||Â² dA'

where:
- Ï‰(x') = (x' - x)/||x' - x|| 
- cos Î¸ = n(x) Â· Ï‰(x')
- cos Î¸' = -n(x') Â· Ï‰(x')
- V(xâ†”x') is the visibility function

The Jacobian is |âˆ‚Ï‰/âˆ‚x'| = cos Î¸'/||r||Â².
</details>

### Exercise 1.6: BSDF Reciprocity with Refraction (Challenge)
Derive the generalized reciprocity relation for BSDF with refraction between media with refractive indices nâ‚ and nâ‚‚.

**Hint:** Use radiance in phase space LÌƒ = L/nÂ².

<details>
<summary>Solution</summary>

Define phase space radiance LÌƒ = L/nÂ². In a medium with index n:

LÌƒ is invariant along rays (generalized radiance theorem)

At an interface, power conservation requires:

LÌƒâ‚(x,Ï‰_i) dÏ‰_i = LÌƒâ‚‚(x,Ï‰_t) dÏ‰_t

Using Snell's law: nâ‚ sin Î¸_i = nâ‚‚ sin Î¸_t

The solid angle ratio is: dÏ‰_t/dÏ‰_i = (nâ‚/nâ‚‚)Â² cos Î¸_t/cos Î¸_i

For the BTDF: f_t(Ï‰_iâ†’Ï‰_t) = dLâ‚‚/dEâ‚ = (nâ‚‚Â²/nâ‚Â²) dLÌƒâ‚‚/dáº¼â‚

By time-reversal symmetry of Maxwell's equations:

nâ‚Â² f_t(x,Ï‰_iâ†’Ï‰_t) = nâ‚‚Â² f_t(x,Ï‰_tâ†’Ï‰_i)
</details>

### Exercise 1.7: Russian Roulette Bias
Prove that Russian roulette with continuation probability q creates an unbiased estimator.

**Hint:** Use the law of total expectation.

<details>
<summary>Solution</summary>

Let L be the true value and L' be the Russian roulette estimator:

L' = {
  L/q  with probability q
  0    with probability 1-q
}

The expected value is:

E[L'] = q Â· (L/q) + (1-q) Â· 0 = L

Therefore E[L'] = L, proving the estimator is unbiased.

The variance is:
Var[L'] = E[L'Â²] - (E[L'])Â² = q(L/q)Â² - LÂ² = LÂ²/q - LÂ² = LÂ²(1-q)/q

Note that variance increases as q decreases, showing the bias-variance tradeoff.
</details>

### Exercise 1.8: Volume Rendering Convergence (Open Problem)
Consider the volume rendering equation with spatially varying extinction. Under what conditions does the path integral formulation converge? Discuss the relationship between optical thickness and convergence rate.

**Hint:** Consider the maximum optical thickness Ï„_max along any ray.

<details>
<summary>Solution</summary>

For volumes with bounded extinction Ïƒ_t â‰¤ Ïƒ_max and albedo Î± = Ïƒ_s/Ïƒ_t â‰¤ Î±_max < 1:

The k-th scattering term is bounded by:
||L^{(k)}||_âˆ â‰¤ ||L_e||_âˆ Î±_max^k

This ensures geometric convergence.

For optical thickness Ï„ = âˆ« Ïƒ_t ds along a ray:
- Low Ï„: Single scattering dominates, fast convergence
- High Ï„: Multiple scattering important, slower convergence
- Ï„ â†’ âˆ: Diffusion regime, may need specialized methods

Open questions:
1. Optimal importance sampling for heterogeneous media
2. Convergence rate vs. spatial frequency of Ïƒ_t
3. Connection to transport mean free path in multiple scattering
</details>

## Common Pitfalls and Errors (Gotchas)

1. **Radiance vs. Irradiance Confusion**
   - Radiance has units W/(mÂ²Â·sr), irradiance has W/mÂ²
   - Always check dimensional consistency in equations
   - Remember: cameras measure irradiance (integrated radiance)

2. **Incorrect Normal Transformation**
   - Normals transform by inverse transpose, not the direct matrix
   - Failing to renormalize after transformation
   - Sign errors when transforming between coordinate systems

3. **BRDF Energy Conservation Violations**
   - Forgetting the cosine term in the integral
   - Not accounting for Fresnel effects at grazing angles
   - Incorrect normalization of analytical BRDF models

4. **Monte Carlo Bias from PDF Errors**
   - PDF must be > 0 wherever integrand is non-zero
   - Normalization errors in importance sampling
   - Forgetting Jacobian when changing variables

5. **Numerical Precision Issues**
   - Ray-sphere intersection can fail due to catastrophic cancellation
   - Small denominators in geometry factor G(xâ†”x')
   - Accumulated error in long ray paths

## Best Practices Checklist

### Design Review

- [ ] **Verify Physical Units**: Check all equations for dimensional consistency
- [ ] **Energy Conservation**: Ensure BRDFs satisfy âˆ« f_r cos Î¸ dÏ‰ â‰¤ 1
- [ ] **Reciprocity**: Verify f_r(Ï‰_i, Ï‰_o) = f_r(Ï‰_o, Ï‰_i)
- [ ] **Coordinate System Consistency**: Document and verify all coordinate conventions
- [ ] **Sampling Strategy**: Match importance sampling to dominant contributions

### Implementation Review

- [ ] **Robust Ray-Primitive Intersection**: Use numerically stable algorithms
- [ ] **PDF Validation**: Assert p(x) > 0 and âˆ« p(x) dx = 1
- [ ] **Variance Reduction**: Implement MIS for multiple sampling strategies
- [ ] **Floating Point Hygiene**: Check for NaN/Inf propagation
- [ ] **Termination Criteria**: Use Russian roulette for infinite recursion

### Debugging Checklist

- [ ] **White Furnace Test**: Uniform emission should produce uniform radiance
- [ ] **Reciprocity Test**: Swap light and camera, verify same result
- [ ] **Energy Audit**: Track total flux in = total flux out
- [ ] **Convergence Analysis**: Plot variance vs. sample count
- [ ] **Reference Comparison**: Validate against analytical solutions when available