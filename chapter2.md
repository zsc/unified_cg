# 第2章：光场与近场光学

本章建立了光场的数学框架，从几何光学的4D光场表示扩展到包含相干性和衍射的波动光学描述。我们将探讨光场的各种表示方法，特别是Wigner分布函数如何统一几何光学和波动光学。通过学习菲涅尔和夫琅禾费衍射理论，以及空间和时间相干性概念，我们为后续章节中的高级渲染技术奠定基础。

## 学习目标

完成本章后，您将能够：
1. 理解并推导4D和5D光场的数学表示
2. 掌握全光函数的概念及其在渲染中的应用
3. 使用Wigner分布函数分析光学系统
4. 从第一性原理推导菲涅尔和夫琅禾费衍射公式
5. 量化分析光源的空间和时间相干性
6. 将光场理论应用于计算机图形学问题

## 2.1 4D和5D光场表示

### 2.1.1 光场的几何定义

光场 L(x, y, θ, φ) 描述了空间中每个点 (x, y) 沿每个方向 (θ, φ) 传播的光强度。在自由空间中，这个4D函数完全描述了光的分布。

对于计算机图形学，我们通常使用两平面参数化：
$$L(u, v, s, t)$$

其中 (u, v) 是第一个平面上的坐标，(s, t) 是第二个平面上的坐标。光线由连接这两点的直线定义。

### 2.1.2 5D光场：包含时间和波长

完整的5D光场表示为：
$$L(x, y, θ, φ, t, λ)$$

或在两平面参数化下：
$$L(u, v, s, t, τ, λ)$$

其中 τ 是时间延迟，λ 是波长。这种表示对于分析时变场景和色散效应至关重要。

### 2.1.3 光场的守恒性质

在无损介质中，光场满足亮度守恒：
$$\frac{∂L}{∂s} = 0$$

这意味着沿光线的辐射亮度保持不变（在几何光学近似下）。

## 2.2 全光函数

### 2.2.1 七维全光函数

Adelson和Bergen提出的全光函数 P(x, y, z, θ, φ, λ, t) 描述了观察者在位置 (x, y, z)、时间 t、观察方向 (θ, φ) 和波长 λ 下感知的光强度。

这个函数可以分解为：
$$P(x, y, z, θ, φ, λ, t) = ∫ L(x', y', z', θ', φ', λ, t') δ(光线约束) dx'dy'dz'dθ'dφ'$$

### 2.2.2 降维与实际应用

在实际应用中，我们通过各种假设降低全光函数的维度：
- 静态场景：消除 t
- 单色光：消除 λ  
- 空自由空间：降至4D光场

### 2.2.3 与渲染方程的关系

全光函数与渲染方程通过以下关系连接：
$$L_o(x, ω_o) = L_e(x, ω_o) + ∫_Ω f_r(x, ω_i, ω_o) L_i(x, ω_i) (ω_i · n) dω_i$$

其中光场 L 对应于入射和出射辐射亮度。

## 2.3 光学中的Wigner分布函数

### 2.3.1 Wigner分布的定义

对于光场 U(x)，其Wigner分布函数定义为：
$$W(x, k) = ∫ U^*(x - ξ/2) U(x + ξ/2) e^{-ikξ} dξ$$

其中 x 是位置，k 是空间频率（与传播角度相关）。

### 2.3.2 相空间表示

Wigner分布提供了光场在位置-角度相空间中的表示。对于4D光场，我们有：
$$W(x, y, k_x, k_y) = ∫∫ L(x - ξ_x/2, y - ξ_y/2, x + ξ_x/2, y + ξ_y/2) e^{-i(k_x ξ_x + k_y ξ_y)} dξ_x dξ_y$$

### 2.3.3 传播与变换

通过自由空间传播距离 z 后，Wigner分布变换为：
$$W'(x, k) = W(x - zk/k_0, k)$$

这是一个相空间中的剪切变换，其中 k_0 = 2π/λ。

### 2.3.4 与光线追踪的联系

在几何光学极限下，Wigner分布退化为光线的相空间表示：
$$W(x, k) → ∑_i I_i δ(x - x_i) δ(k - k_i)$$

## 2.4 菲涅尔和夫琅禾费衍射

### 2.4.1 惠更斯-菲涅尔原理

从波动方程出发，光场传播满足：
$$U(P) = \frac{1}{iλ} ∫∫_Σ U(Q) \frac{e^{ikr}}{r} cos(n, r) dΣ$$

其中 P 是观察点，Q 是孔径上的点，r 是它们之间的距离。

### 2.4.2 菲涅尔衍射

在菲涅尔近似下（近场），传播核为：
$$h(x, y; x', y') = \frac{e^{ikz}}{iλz} exp\left[\frac{ik}{2z}[(x-x')^2 + (y-y')^2]\right]$$

衍射场为：
$$U(x, y) = ∫∫ U_0(x', y') h(x, y; x', y') dx' dy'$$

### 2.4.3 夫琅禾费衍射

在远场（夫琅禾费区域），衍射简化为傅里叶变换：
$$U(x, y) = \frac{e^{ikz}}{iλz} e^{ik(x^2+y^2)/2z} \mathcal{F}\{U_0\}\left(\frac{x}{λz}, \frac{y}{λz}\right)$$

其中 $\mathcal{F}$ 表示傅里叶变换。

### 2.4.4 数值计算考虑

菲涅尔数 F = a²/(λz) 决定了使用哪种近似：
- F >> 1：几何光学
- F ≈ 1：菲涅尔衍射
- F << 1：夫琅禾费衍射

## 2.5 空间和时间相干性

### 2.5.1 互相干函数

两点间的互相干函数定义为：
$$Γ(r_1, r_2, τ) = \langle U^*(r_1, t) U(r_2, t + τ) \rangle$$

归一化后得到复相干度：
$$γ(r_1, r_2, τ) = \frac{Γ(r_1, r_2, τ)}{\sqrt{I(r_1)I(r_2)}}$$

### 2.5.2 时间相干性

时间相干性由相干时间 τ_c 和相干长度 l_c = cτ_c 表征。对于光谱宽度 Δν 的光源：
$$τ_c ≈ \frac{1}{Δν}$$

时间相干性影响干涉条纹的可见度：
$$V = |γ(τ)| = |\mathcal{F}\{S(ν)\}|$$

其中 S(ν) 是归一化光谱密度。

### 2.5.3 空间相干性

空间相干性由相干面积表征。根据van Cittert-Zernike定理，扩展非相干源产生的场的空间相干性为：
$$γ(r_1, r_2) = \frac{∫∫ I(ξ, η) e^{ik[(r_1-r_2)·(ξ,η)]/z} dξdη}{∫∫ I(ξ, η) dξdη}$$

对于均匀圆形源，相干半径为：
$$ρ_c ≈ 1.22 \frac{λz}{D}$$

其中 D 是源的直径，z 是观察距离。

### 2.5.4 相干性与渲染

在计算机图形学中，相干性影响：
- 散斑图案的形成
- 薄膜干涉的可见度
- 全息显示的质量
- 激光投影系统的设计

## 本章小结

本章建立了光场理论的数学基础，主要概念包括：

1. **4D/5D光场表示**：L(u, v, s, t, λ) 完整描述光的空间、角度和光谱分布
2. **全光函数**：七维函数 P(x, y, z, θ, φ, λ, t) 描述所有可能的视觉信息
3. **Wigner分布**：W(x, k) 统一了几何光学和波动光学的相空间表示
4. **衍射理论**：菲涅尔数 F = a²/(λz) 决定使用几何、菲涅尔或夫琅禾费近似
5. **相干性**：时间相干长度 l_c ≈ c/Δν，空间相干半径 ρ_c ≈ 1.22λz/D

这些概念为理解现代渲染技术（如光场相机、全息显示）提供了理论基础。

## 练习题

### 基础题

**练习 2.1**：证明两平面参数化的4D光场在自由空间传播时满足亮度守恒。  
*提示*：使用光线的参数方程和雅可比行列式。

<details>
<summary>答案</summary>

设光线从平面1 (u, v) 传播到平面2 (s, t)，距离为 d。光线方程为：
$$s = u + d \cdot \tan θ_x, \quad t = v + d \cdot \tan θ_y$$

雅可比行列式：
$$J = \left|\frac{∂(s,t)}{∂(u,v)}\right| = 1$$

因此 L(u, v, s, t) = L(u', v', s', t')，证明了亮度守恒。
</details>

**练习 2.2**：对于直径 D = 1 mm 的圆形非相干光源，波长 λ = 500 nm，计算在距离 z = 1 m 处的空间相干半径。  
*提示*：使用van Cittert-Zernike定理的结果。

<details>
<summary>答案</summary>

使用公式 ρ_c ≈ 1.22λz/D：
$$ρ_c = 1.22 × \frac{500 × 10^{-9} × 1}{10^{-3}} = 0.61 \text{ mm}$$

这意味着相距超过0.61 mm的两点基本不相干。
</details>

**练习 2.3**：推导菲涅尔数 F = 1 时的衍射场强度分布。  
*提示*：考虑圆孔的菲涅尔衍射积分。

<details>
<summary>答案</summary>

对于半径 a 的圆孔，F = a²/(λz) = 1 意味着 z = a²/λ。

轴上强度：
$$I(0) = I_0 |1 - e^{ika²/2z}|² = I_0 |1 - e^{iπ}|² = 4I_0$$

这是几何阴影强度的4倍，展示了菲涅尔衍射的聚焦效应。
</details>

### 挑战题

**练习 2.4**：推导Wigner分布函数通过薄透镜的变换规律。透镜焦距为 f。  
*提示*：薄透镜相位变换为 exp[-ik(x² + y²)/2f]。

<details>
<summary>答案</summary>

薄透镜引入二次相位：
$$U'(x) = U(x) \exp\left[-\frac{ik x²}{2f}\right]$$

Wigner分布变换为：
$$W'(x, k) = W(x, k + \frac{x}{f})$$

这是相空间中的另一种剪切变换，与自由传播的剪切方向正交。组合得到ABCD矩阵光学。
</details>

**练习 2.5**：证明部分相干光的4D光场表示需要考虑互相干函数 Γ(r₁, r₂)。推导相应的广义光场方程。  
*提示*：从统计光学出发，考虑场的二阶相关。

<details>
<summary>答案</summary>

部分相干光场不能用确定性函数L(u, v, s, t)描述。需要引入互强度：
$$J(u₁, v₁, u₂, v₂) = \langle L^*(u₁, v₁, s, t) L(u₂, v₂, s, t) \rangle$$

传播方程：
$$J(s₁, t₁, s₂, t₂) = ∫∫∫∫ h^*(s₁-u₁, t₁-v₁) h(s₂-u₂, t₂-v₂) J(u₁, v₁, u₂, v₂) du₁dv₁du₂dv₂$$

其中h是传播核。这导致光场维度翻倍：4D → 8D。
</details>

**练习 2.6**：设计一个算法，从多视角图像重建4D光场。分析采样要求和重建误差。  
*提示*：考虑极线几何约束和频域分析。

<details>
<summary>答案</summary>

算法框架：
1. 极线约束：对应点满足 x'ᵀFx = 0
2. 视差与深度：d = f·B/Z
3. 光场重建：L(u, v, s, t) = I(u + d(s-u)/z, v + d(t-v)/z)

采样要求（Nyquist）：
- 角度采样：Δθ < λ/D（D是场景尺度）
- 空间采样：Δx < λz/D（z是深度范围）

重建误差主要来自：
- 遮挡区域：O(遮挡面积/总面积)
- 深度误差：δL/L ≈ δZ/Z
- 混叠：当违反Nyquist条件时
</details>

### 开放性思考题

**练习 2.7**：讨论如何将传统光线追踪算法扩展以处理波动光学效应。考虑计算复杂度和精度权衡。  
*提示*：思考混合几何-波动方法。

<details>
<summary>答案</summary>

可能的方法：
1. **局部波动修正**：在需要时（如边缘、小孔）切换到波动计算
2. **相位光线追踪**：追踪复振幅而非仅强度
3. **Wigner函数光线追踪**：在相空间追踪，自然包含衍射

复杂度分析：
- 纯几何：O(N log N)（N是光线数）
- 局部波动：O(N log N + M·K²)（M是衍射区域，K是采样点）
- 全波动：O(N³)（体积离散化）

建议：根据菲涅尔数自适应选择方法。
</details>

**练习 2.8**：探讨机器学习如何用于光场压缩和重建。设计一个网络架构并分析其理论基础。  
*提示*：考虑光场的低秩结构和稀疏性。

<details>
<summary>答案</summary>

网络架构建议：
1. **编码器**：4D卷积提取光场特征
2. **低秩分解**：类似TensoRF的向量-矩阵分解
3. **解码器**：上采样重建完整光场

理论基础：
- 光场在无遮挡区域是低秩的（秩 ≤ 场景复杂度）
- 傅里叶域稀疏性（大部分能量集中在低频）
- 极线一致性提供额外约束

损失函数：
$$\mathcal{L} = ||L - L_{gt}||_2 + λ_1||∇L||_1 + λ_2 \mathcal{L}_{epi}$$

其中 $\mathcal{L}_{epi}$ 是极线一致性损失。
</details>

## 常见陷阱与错误

### 陷阱 1：混淆4D光场的不同参数化
**错误**：直接在 (x, y, θ, φ) 和 (u, v, s, t) 之间转换  
**正确**：需要考虑坐标系和采样结构的差异

### 陷阱 2：忽略相干性在干涉中的作用
**错误**：假设所有光源都能产生稳定干涉  
**正确**：只有相干长度内的光程差才能产生干涉

### 陷阱 3：错误使用菲涅尔近似
**错误**：在近场直接使用夫琅禾费公式  
**正确**：检查菲涅尔数F，选择合适的近似

### 陷阱 4：Wigner分布的物理解释
**错误**：将W(x, k)解释为位置x处沿方向k的强度  
**正确**：W可以为负，是准概率分布

### 陷阱 5：光场采样不足
**错误**：使用稀疏相机阵列重建光场  
**正确**：满足角度和空间Nyquist条件

## 最佳实践检查清单

### 光场表示选择
- [ ] 根据应用选择合适的参数化（光线角度 vs 两平面）
- [ ] 考虑是否需要时间和光谱维度
- [ ] 评估存储和计算需求

### 衍射计算
- [ ] 计算菲涅尔数确定适用的近似
- [ ] 验证采样满足Nyquist条件
- [ ] 考虑边界效应和零填充

### 相干性分析
- [ ] 识别光源类型（激光/LED/热光源）
- [ ] 计算相干长度和相干面积
- [ ] 在设计光学系统时考虑相干性限制

### 数值实现
- [ ] 使用FFT加速卷积计算
- [ ] 注意相位展开和2π模糊
- [ ] 验证能量守恒

### 算法优化
- [ ] 利用光场的稀疏性和低秩性
- [ ] 考虑空间-角度分辨率权衡
- [ ] 实现自适应采样策略