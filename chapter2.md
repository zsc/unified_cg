# 第2章：光场与近场光学

本章建立了光场的数学框架，从几何光学的4D光场表示扩展到包含相干性和衍射的波动光学描述。我们将探讨光场的各种表示方法，特别是Wigner分布函数如何统一几何光学和波动光学。通过学习菲涅尔和夫琅禾费衍射理论，以及空间和时间相干性概念，我们为后续章节中的高级渲染技术奠定基础。

## 学习目标

完成本章后，您将能够：
1. 理解并推导4D和5D光场的数学表示
2. 掌握全光函数的概念及其在渲染中的应用
3. 使用Wigner分布函数分析光学系统
4. 从第一性原理推导菲涅尔和夫琅禾费衍射公式
5. 量化分析光源的空间和时间相干性
6. 将光场理论应用于计算机图形学问题

## 2.1 4D和5D光场表示

### 2.1.1 光场的几何定义

光场 L(x, y, θ, φ) 描述了空间中每个点 (x, y) 沿每个方向 (θ, φ) 传播的光强度。在自由空间中，这个4D函数完全描述了光的分布。

对于计算机图形学，我们通常使用两平面参数化：
$$L(u, v, s, t)$$

其中 (u, v) 是第一个平面上的坐标，(s, t) 是第二个平面上的坐标。光线由连接这两点的直线定义。

#### 参数化之间的转换

从光线参数 (x, y, θ, φ) 到两平面参数化的转换关系为：
$$u = x - d_1 \tan θ \cos φ$$
$$v = y - d_1 \tan θ \sin φ$$
$$s = x + d_2 \tan θ \cos φ$$
$$t = y + d_2 \tan θ \sin φ$$

其中 d₁ 和 d₂ 是到两个参考平面的距离。

#### 光场的积分表示

光场可以通过场景的辐射度函数积分得到：
$$L(u, v, s, t) = \int_{\mathcal{S}} \rho(\mathbf{p}) V(\mathbf{p}, \mathbf{r}_{u,v,s,t}) G(\mathbf{p}, \mathbf{r}_{u,v,s,t}) dA(\mathbf{p})$$

其中：
- ρ(p) 是表面点p的反射率
- V 是可见性函数（0或1）
- G 是几何项：$G = \frac{\cos θ_i \cos θ_o}{||\mathbf{p} - \mathbf{r}||^2}$

### 2.1.2 5D光场：包含时间和波长

完整的5D光场表示为：
$$L(x, y, θ, φ, t, λ)$$

或在两平面参数化下：
$$L(u, v, s, t, τ, λ)$$

其中 τ 是时间延迟，λ 是波长。这种表示对于分析时变场景和色散效应至关重要。

#### 时间维度的物理意义

时间维度允许我们描述：
1. **运动模糊**：快门开启期间的积分
   $$L_{blur}(u, v, s, t) = \frac{1}{T} \int_0^T L(u, v, s, t, τ) dτ$$

2. **频闪效应**：周期性照明下的采样
   $$L_{strobe}(u, v, s, t, n) = L(u, v, s, t, nT_s)$$

3. **光脉冲传播**：超快成像中的时间分辨
   $$L_{pulse}(u, v, s, t, τ) = L_0(u, v, s, t) h(τ - d/c)$$
   
   其中 h 是脉冲形状函数，d 是传播距离。

#### 光谱维度的重要性

波长维度捕获：
1. **色散**：不同波长的折射率差异
   $$n(λ) = A + \frac{B}{λ^2} + \frac{C}{λ^4} + ...$$ (Cauchy公式)

2. **光谱BRDF**：材质的波长依赖反射
   $$f_r(\mathbf{ω}_i, \mathbf{ω}_o, λ)$$

3. **荧光效应**：波长转换
   $$L_o(λ_o) = \int f_{fluorescence}(λ_i, λ_o) L_i(λ_i) dλ_i$$

### 2.1.3 光场的守恒性质

在无损介质中，光场满足亮度守恒：
$$\frac{∂L}{∂s} = 0$$

这意味着沿光线的辐射亮度保持不变（在几何光学近似下）。

#### 刘维尔定理的应用

更一般地，光场在相空间中满足刘维尔定理：
$$\frac{dL}{dt} = \frac{∂L}{∂t} + \{\mathcal{H}, L\} = 0$$

其中 {·,·} 是泊松括号，$\mathcal{H}$ 是哈密顿量。

泊松括号的展开形式：
$$\{f, g\} = \sum_i \left(\frac{∂f}{∂q_i}\frac{∂g}{∂p_i} - \frac{∂f}{∂p_i}\frac{∂g}{∂q_i}\right)$$

对于自由传播：
$$\mathcal{H} = c||\mathbf{k}|| = c\sqrt{k_x^2 + k_y^2 + k_z^2}$$

运动方程通过哈密顿正则方程给出：
$$\frac{dq_i}{dt} = \frac{∂\mathcal{H}}{∂p_i}, \quad \frac{dp_i}{dt} = -\frac{∂\mathcal{H}}{∂q_i}$$

在傍轴近似下（$k_z \gg k_x, k_y$）：
$$\mathcal{H} \approx ck_z + \frac{c}{2k_z}(k_x^2 + k_y^2)$$

这导出了光场传播的基本方程：
$$L(u', v', s', t') = L(u, v, s, t)$$

当光线从 (u,v) 传播到 (s',t') 时。

#### 相空间体积守恒

在哈密顿光学框架下，光场在相空间中的演化保持体积不变：
$$\iiint\int L(x, y, p_x, p_y) dx dy dp_x dp_y = \text{const}$$

其中 $(p_x, p_y) = (n\sin\theta_x, n\sin\theta_y)$ 是光学动量。

这一守恒律导致了重要的光学不变量：
$$n^2 A \Omega = \text{const}$$

其中 A 是光束截面积，Ω 是立体角，n 是折射率。这就是著名的étendue（光学扩展量）守恒。

推导过程：考虑光束通过光学系统，入射和出射参数满足：
$$n_1^2 A_1 \Omega_1 = n_2^2 A_2 \Omega_2$$

对于小立体角：$\Omega = \pi \sin^2\theta_{max}$

这导出了数值孔径的不变性：
$$n_1 A_1 \text{NA}_1^2 = n_2 A_2 \text{NA}_2^2$$

其中 NA = n sin θ 是数值孔径。

#### 光场采样定理

Chai等人证明了光场的采样要求与场景深度相关：
$$Δu · Δs ≥ \frac{λ(z_{max} - z_{min})}{z_{min}}$$

这是光场相机设计的基础约束。

更精确的分析表明，光场的频谱支撑区域是一个双锥：
$$\Omega_{LF} = \{(f_u, f_v, f_s, f_t) : |f_s| \leq \frac{z_{max}}{λ}|f_u|, |f_t| \leq \frac{z_{max}}{λ}|f_v|\}$$

这导出了最优采样策略：
- 角度分辨率：$\Delta\theta < \frac{\lambda}{D_{aperture}}$
- 空间分辨率：$\Delta x < \frac{\lambda z_{min}}{D_{scene}}$

### 2.1.4 光场的变换与投影

#### 光场的仿射变换

考虑相机的运动，光场经历仿射变换：
$$L'(u', v', s', t') = L(Au + Bs + E, Cv + Dt + F, s, t)$$

其中变换矩阵编码了相机的平移和旋转。

完整的4D变换矩阵形式：
$$\begin{pmatrix} u' \\ v' \\ s' \\ t' \end{pmatrix} = \mathbf{T} \begin{pmatrix} u \\ v \\ s \\ t \end{pmatrix} + \mathbf{d}$$

对于纯平移 $(t_x, t_y, t_z)$：
$$\begin{pmatrix} u' \\ v' \\ s' \\ t' \end{pmatrix} = \begin{pmatrix} 1 & 0 & -t_z/z_0 & 0 \\ 0 & 1 & 0 & -t_z/z_0 \\ 0 & 0 & 1 & 0 \\ 0 & 0 & 0 & 1 \end{pmatrix} \begin{pmatrix} u \\ v \\ s \\ t \end{pmatrix} + \begin{pmatrix} t_x \\ t_y \\ 0 \\ 0 \end{pmatrix}$$

对于旋转角度 θ（绕 z 轴）：
$$\mathbf{T}_{rot} = \begin{pmatrix} 
\cos\theta & \sin\theta & 0 & 0 \\
-\sin\theta & \cos\theta & 0 & 0 \\
0 & 0 & \cos\theta & \sin\theta \\
0 & 0 & -\sin\theta & \cos\theta
\end{pmatrix}$$

#### 光场的投影操作

从4D光场生成2D图像的过程是一个投影操作：

1. **针孔相机**：
   $$I(x, y) = L(x, y, x, y)$$
   选择共线的 $(u, v) = (s, t)$

2. **有限孔径相机**：
   $$I(x, y) = \int\int_{aperture} L(u, v, x, y) A(u, v) du dv$$
   其中 A(u, v) 是孔径函数
   
   对于圆形孔径：$A(u, v) = \text{circ}(\sqrt{u^2 + v^2}/R)$
   
   景深公式：
   $$\text{DOF} = \frac{2Nc(z_f^2 - z_n^2)}{f^2}$$
   其中 N 是 f 数，c 是混淆圆直径，$z_f, z_n$ 是远近焦平面。

3. **光场相机**（聚焦后）：
   $$I(x, y) = \int\int L(u, v, u + \alpha(x-u), v + \alpha(y-v)) du dv$$
   其中 α 控制焦平面深度
   
   焦平面深度与 α 的关系：
   $$z_{focus} = \frac{z_{uv} \cdot z_{st}}{z_{st} - \alpha(z_{st} - z_{uv})}$$

4. **积分成像**（多视点）：
   $$I_n(x, y) = L(u_n, v_n, x, y)$$
   其中 $(u_n, v_n)$ 是第 n 个视点位置

#### 光场的剪切操作

聚焦对应于光场的4D剪切：
$$L_{focused}(u, v, s, t) = L(u, v, s + \alpha u, t + \alpha v)$$

剪切矩阵表示：
$$\mathbf{S}_\alpha = \begin{pmatrix} 
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
\alpha & 0 & 1 & 0 \\
0 & \alpha & 0 & 1
\end{pmatrix}$$

在频域中，这是一个相位调制：
$$\tilde{L}_{focused}(f_u, f_v, f_s, f_t) = \tilde{L}(f_u - \alpha f_s, f_v - \alpha f_t, f_s, f_t)$$

剪切定理的一般形式：
$$\mathcal{F}\{f(x - \alpha y, y)\} = e^{-2\pi i \alpha f_x f_y} \tilde{f}(f_x, f_y)$$

### 2.1.5 光场的稀疏表示

#### 基于表面的光场参数化

对于大多数真实场景，光场具有固有的2D结构（表面约束）：
$$L(u, v, s, t) = \sum_i R_i(u, v, s, t) \delta(d_i(u, v, s, t))$$

其中 $d_i$ 是到第i个表面的符号距离函数，$R_i$ 是表面的反射特性。

#### 光场的低秩分解

利用场景的低维结构，光场可以分解为：
$$L(u, v, s, t) \approx \sum_{k=1}^r \sigma_k U_k(u, v) V_k(s, t)$$

其中 r 是有效秩，通常 r << min(UV, ST)。

这种分解的误差界为：
$$||L - L_r||_F \leq \sqrt{\sum_{k=r+1}^{\min(UV,ST)} \sigma_k^2}$$

#### 光场的稀疏傅里叶表示

在频域中，光场能量集中在低频区域。定义稀疏度：
$$\text{Sparsity}(L) = \frac{||\tilde{L}||_0}{||\tilde{L}||_2}$$

对于典型场景，超过99%的能量集中在不到1%的频率分量中。

## 2.2 全光函数

### 2.2.1 七维全光函数

Adelson和Bergen提出的全光函数 P(x, y, z, θ, φ, λ, t) 描述了观察者在位置 (x, y, z)、时间 t、观察方向 (θ, φ) 和波长 λ 下感知的光强度。

这个函数可以分解为：
$$P(x, y, z, θ, φ, λ, t) = ∫ L(x', y', z', θ', φ', λ, t') δ(光线约束) dx'dy'dz'dθ'dφ'$$

光线约束的具体形式：
$$\delta(光线约束) = \delta(\mathbf{x} - \mathbf{x}' - s\mathbf{ω}) \delta(\mathbf{ω} - \mathbf{ω}')$$

其中 s 是从观察点到场景点的距离。

#### 全光函数的物理解释

全光函数捕获了视觉世界的完整信息：
1. **空间位置** (x, y, z)：观察者的3D位置
2. **观察方向** (θ, φ)：视线的球面角度
3. **波长** λ：电磁辐射的光谱成分（380-780 nm 可见光）
4. **时间** t：动态场景的时间演化

从信息论角度，全光函数包含了产生任何可能视觉体验所需的所有信息。

维度分析：
- 空间：3D连续流形
- 方向：2D球面 S²
- 光谱：1D正实轴
- 时间：1D实轴
- 总维度：7D流形 ℝ³ × S² × ℝ⁺ × ℝ

#### 全光函数的积分形式

考虑场景中的光传播，全光函数可以表示为：
$$P(\mathbf{x}, \mathbf{ω}, λ, t) = \int_0^∞ L(\mathbf{x} - s\mathbf{ω}, \mathbf{ω}, λ, t - s/c) e^{-\int_0^s σ_t(\mathbf{x} - s'\mathbf{ω}, λ) ds'} ds$$

其中：
- σ_t 是介质的消光系数（吸收 + 散射）
- 积分沿着观察方向 ω 进行
- 指数项表示介质中的衰减（Beer-Lambert定律）

对于散射介质，需要加入内散射项：
$$P(\mathbf{x}, \mathbf{ω}, λ, t) = \int_0^∞ \left[L_e + \int_{4π} f_p(\mathbf{ω}', \mathbf{ω}) L_{in}(\mathbf{ω}') d\mathbf{ω}'\right] T(s) ds$$

其中：
- $L_e$ 是自发光项
- $f_p$ 是相位函数
- $T(s) = e^{-\int_0^s σ_t ds'}$ 是透射率

### 2.2.2 降维与实际应用

在实际应用中，我们通过各种假设降低全光函数的维度：

#### 常见的降维策略

1. **静态场景** (6D)：消除 t
   $$P_{static}(x, y, z, θ, φ, λ) = P(x, y, z, θ, φ, λ, t_0)$$

2. **单色光** (6D)：消除 λ  
   $$P_{mono}(x, y, z, θ, φ, t) = \int S(λ) P(x, y, z, θ, φ, λ, t) dλ$$
   
   其中 S(λ) 是光谱灵敏度函数。

3. **自由空间** (4D)：降至4D光场
   $$L(u, v, s, t) = P(x(u,s), y(v,t), z, θ(u,s), φ(v,t))$$
   
   在无遮挡空间中，光线参数化简化了表示。

4. **平面约束** (3D)：相机在平面上移动
   $$P_{planar}(x, y, θ, φ) = P(x, y, z_0, θ, φ)$$

#### 渲染技术与全光函数维度

不同渲染技术对应不同的全光函数采样：

| 技术 | 采样维度 | 全光函数约束 |
|------|----------|--------------|
| 光线追踪 | 2D (像素) | 固定相机位置 |
| 光场渲染 | 4D | 自由空间假设 |
| 体积渲染 | 5D | 包含空间位置 |
| 时空渲染 | 6D | 包含时间维度 |

### 2.2.3 与渲染方程的关系

全光函数与渲染方程通过以下关系连接：
$$L_o(x, ω_o) = L_e(x, ω_o) + ∫_Ω f_r(x, ω_i, ω_o) L_i(x, ω_i) (ω_i · n) dω_i$$

其中光场 L 对应于入射和出射辐射亮度。

#### 从全光函数推导渲染方程

给定全光函数 P，表面点 x 的入射辐射度为：
$$L_i(x, ω_i) = P(x, -ω_i, λ, t)$$

出射辐射度通过BRDF积分得到：
$$L_o(x, ω_o) = L_e(x, ω_o) + \int_Ω f_r(x, ω_i, ω_o) P(x, -ω_i, λ, t) (ω_i · n) dω_i$$

这建立了局部着色模型与全局光传输的联系。

#### 路径积分表述

将渲染方程递归展开，得到路径积分：
$$L(x_0 → x_1) = \sum_{n=1}^∞ \int_{\mathcal{P}_n} L_e(x_n → x_{n-1}) \prod_{i=1}^{n-1} f_r(x_{i+1} → x_i → x_{i-1}) G(x_i ↔ x_{i+1}) d\mathcal{P}_n$$

其中 $\mathcal{P}_n$ 是长度为 n 的路径空间。

#### 测量方程

相机传感器的响应是全光函数的加权积分：
$$I_{pixel} = \int_A \int_Ω \int_T \int_Λ W(x, ω, t, λ) P(x, ω, λ, t) dλ dt dω dA$$

其中 W 是像素的响应函数，包含：
- 空间滤波器（像素形状）
- 角度滤波器（孔径）
- 时间滤波器（快门）
- 光谱滤波器（色彩滤镜）

### 2.2.4 全光函数的现代应用

#### 神经辐射场 (NeRF)

NeRF本质上是学习场景的5D全光函数近似：
$$F_θ: (x, y, z, θ, φ) → (r, g, b, σ)$$

其中神经网络 F_θ 隐式编码了全光函数。

训练过程可以表述为最小化重建误差：
$$\mathcal{L} = \sum_{rays} ||C(r) - \hat{C}(r)||^2$$

其中 $\hat{C}(r)$ 是沿光线 r 的体积渲染：
$$\hat{C}(r) = \int_0^∞ T(t) σ(r(t)) c(r(t), d) dt$$

透射率 $T(t) = \exp(-\int_0^t σ(r(s)) ds)$ 编码了遮挡关系。

#### 光场相机

光场相机直接采样4D光场：
$$L_{captured}(u, v, s, t) = \int W_{microlens}(u, v, s, t) L_{scene}(u, v, s, t) dudvdsdt$$

微透镜阵列实现了空间-角度的联合采样。

设计参数的权衡：
- 微透镜直径 d：角度分辨率 ∝ 1/d
- 微透镜焦距 f：空间分辨率 ∝ f/d
- 传感器像素尺寸 p：总分辨率受限于 min(空间, 角度)

光场相机的调制传递函数（MTF）：
$$\text{MTF}(f_x, f_θ) = \text{sinc}(d f_x) \cdot \text{sinc}(p f_θ/f)$$

#### 计算摄影

许多计算摄影技术可以理解为全光函数的特殊采样：
- **HDR成像**：扩展动态范围的λ维采样
  $$P_{HDR}(x, y, θ, φ) = \sum_i w_i(L) P(x, y, θ, φ, t_i)$$
  其中 $w_i$ 是基于亮度的权重函数

- **光场显微镜**：高分辨率的4D光场采样
  $$P_{micro}(x, y, z, θ, φ) = \int PSF(x', y', z') P(x-x', y-y', z-z', θ, φ) dx'dy'dz'$$
  
- **飞行时间成像**：利用时间维度测量深度
  $$d(x, y) = \frac{c}{2} \arg\max_τ \{P(x, y, τ) \star h(τ)\}$$
  其中 h(τ) 是发射脉冲形状

### 2.2.5 全光函数的信息理论分析

#### 信息容量

全光函数的信息容量受物理约束限制：
$$I_{max} = \frac{V_{scene} \cdot \Omega_{view} \cdot T \cdot B}{\lambda^3 \cdot c}$$

其中：
- $V_{scene}$：场景体积
- $\Omega_{view}$：观察立体角
- T：时间窗口
- B：光谱带宽

对于典型室内场景（10m³，4π立体角，1秒，可见光谱）：
$$I_{max} \approx 10^{25} \text{ bits}$$

#### 压缩与冗余

真实场景的全光函数具有大量冗余：
1. **空间相干性**：相邻光线相似
2. **时间连续性**：运动平滑
3. **光谱相关性**：颜色通道相关
4. **几何约束**：满足极线几何

有效压缩比可达 $10^6:1$ 而不显著损失感知质量。

#### 采样理论的信息论视角

根据率失真理论，给定失真容限 D，所需采样率：
$$R(D) \geq H(P) - H(D)$$

其中 H(P) 是全光函数的熵，H(D) 是容许失真的熵。

这导出了自适应采样策略：
- 高纹理区域：密集采样
- 平滑区域：稀疏采样
- 遮挡边界：超采样

## 2.3 光学中的Wigner分布函数

### 2.3.1 Wigner分布的定义

对于光场 U(x)，其Wigner分布函数定义为：
$$W(x, k) = ∫ U^*(x - ξ/2) U(x + ξ/2) e^{-ikξ} dξ$$

其中 x 是位置，k 是空间频率（与传播角度相关）。

等价的频域表示：
$$W(x, k) = \frac{1}{2π} ∫ \tilde{U}^*(k - κ/2) \tilde{U}(k + κ/2) e^{ixκ} dκ$$

对于2D光场，Wigner分布推广为：
$$W(x, y, k_x, k_y) = \int\int U^*(x - ξ_x/2, y - ξ_y/2) U(x + ξ_x/2, y + ξ_y/2) e^{-i(k_x ξ_x + k_y ξ_y)} dξ_x dξ_y$$

#### 从量子力学到光学的类比

Wigner分布最初在量子力学中引入，用于相空间中的准概率分布。在光学中：
- 位置 x ↔ 横向坐标
- 动量 p ↔ 横向波矢 k = k₀sin θ（k₀ = 2π/λ）
- 波函数 ψ ↔ 光场振幅 U
- 普朗克常数 ℏ ↔ 波长 λ/2π

对应关系：
$$W_{quantum}(x, p) \leftrightarrow W_{optics}(x, k)$$
$$[x, p] = iℏ \leftrightarrow \Delta x \Delta k ≥ 1/2$$

#### Wigner分布的性质

1. **实值性**：W(x, k) ∈ ℝ，即使对复光场
   证明：$W^*(x, k) = W(x, k)$

2. **边缘分布**：
   $$\int W(x, k) dk = |U(x)|^2$$ （强度分布）
   $$\int W(x, k) dx = |\tilde{U}(k)|^2$$ （角谱分布）
   
3. **非正定性**：W(x, k) 可以为负，因此是准概率分布
   负值区域表示量子/波动干涉效应

4. **归一化**：$$\int\int W(x, k) dx dk = \int |U(x)|^2 dx$$ （总功率）

5. **平移不变性**：
   若 $U'(x) = U(x - x_0)$，则 $W'(x, k) = W(x - x_0, k)$

6. **调制性质**：
   若 $U'(x) = U(x)e^{ik_0 x}$，则 $W'(x, k) = W(x, k - k_0)$

7. **尺度变换**：
   若 $U'(x) = \sqrt{a}U(ax)$，则 $W'(x, k) = W(ax, k/a)$

### 2.3.2 相空间表示

Wigner分布提供了光场在位置-角度相空间中的表示。对于4D光场，我们有：
$$W(x, y, k_x, k_y) = \int\int L(x - ξ_x/2, y - ξ_y/2, x + ξ_x/2, y + ξ_y/2) e^{-i(k_x ξ_x + k_y ξ_y)} dξ_x dξ_y$$

#### 相空间的几何解释

在相空间 (x, k) 中：
- **点**：表示具有确定位置和传播方向的光线
- **水平线**：平面波（确定的 k，所有 x）
- **垂直线**：点源（确定的 x，所有 k）
- **倾斜线**：会聚/发散球面波

#### 相空间体积与信息容量

根据相空间不确定性原理：
$$Δx · Δk ≥ \frac{1}{2}$$

这限制了光学系统的信息容量。对于有限孔径系统：
$$N_{DOF} ≈ \frac{A_{object} · Ω_{NA}}{λ^2}$$

其中 A_{object} 是物体面积，Ω_{NA} 是数值孔径对应的立体角。

### 2.3.3 传播与变换

通过自由空间传播距离 z 后，Wigner分布变换为：
$$W'(x, k) = W(x - zk/k_0, k)$$

这是一个相空间中的剪切变换，其中 k_0 = 2π/λ。

#### ABCD矩阵形式

对于一般的傍轴光学系统，Wigner分布通过线性正则变换：
$$W'(x', k') = W(Dx - Bk, -Cx + Ak)$$

其中 ABCD 是光学系统的传输矩阵：
$$\begin{pmatrix} x' \\ k' \end{pmatrix} = \begin{pmatrix} A & B \\ C & D \end{pmatrix} \begin{pmatrix} x \\ k \end{pmatrix}$$

常见光学元件的ABCD矩阵：
- 自由传播 z：$\begin{pmatrix} 1 & z/k_0 \\ 0 & 1 \end{pmatrix}$
- 薄透镜 f：$\begin{pmatrix} 1 & 0 \\ -k_0/f & 1 \end{pmatrix}$
- 傅里叶变换：$\begin{pmatrix} 0 & 1/k_0 \\ -k_0 & 0 \end{pmatrix}$

#### 分数傅里叶变换

Wigner分布在分数傅里叶变换下旋转角度 α：
$$W_α(x_α, k_α) = W(x\cos α - k\sin α/k_0, k_0(x\sin α + k\cos α/k_0))$$

这提供了相空间中的统一描述：
- α = 0：恒等变换
- α = π/2：标准傅里叶变换
- α = π：反演
- 0 < α < π/2：分数域

### 2.3.4 与光线追踪的联系

在几何光学极限下，Wigner分布退化为光线的相空间表示：
$$W(x, k) → ∑_i I_i δ(x - x_i) δ(k - k_i)$$

#### 从波动到几何的过渡

考虑高斯光束的Wigner分布：
$$W(x, k) = \frac{1}{π} \exp\left[-\frac{x^2}{w^2} - \frac{k^2w^2}{k_0^2}\right]$$

其中 w 是束腰半径。当 w >> λ 时：
- 相空间分布变得高度局域化
- 可以用光线束近似
- 衍射效应可忽略

#### 光线光学中的相空间

在光线光学中，Wigner分布简化为：
$$W_{ray}(x, θ) = \sum_i I_i(s) δ(x - x_i(s)) δ(θ - θ_i(s))$$

其中 s 是沿光线的参数。这导出了：
- **光程函数**：S(x) = ∫ n(s) ds
- **程函方程**：|∇S|² = n²
- **光线方程**：$\frac{d}{ds}\left(n\frac{d\mathbf{r}}{ds}\right) = ∇n$

### 2.3.5 Wigner分布的计算方法

#### 直接计算

从光场U(x)计算Wigner分布：
```
1. 对每个位置x和频率k：
   - 计算U*(x - ξ/2)U(x + ξ/2)
   - 乘以exp(-ikξ)
   - 对ξ积分
2. 处理边界效应（零填充或周期延拓）
```

#### 基于FFT的快速算法

利用Wigner分布与模糊函数的关系：
$$W(x, k) = \mathcal{F}_ξ\{U^*(x - ξ/2)U(x + ξ/2)\}$$

计算复杂度：O(N²log N)，其中N是采样点数。

#### 相空间层析

从多个投影重建Wigner分布：
$$R_θ(t) = \int W(t\cos θ - s\sin θ, t\sin θ + s\cos θ) ds$$

这是Radon变换，可用于从强度测量重建相位信息。

## 2.4 菲涅尔和夫琅禾费衍射

### 2.4.1 惠更斯-菲涅尔原理

从波动方程出发，光场传播满足：
$$U(P) = \frac{1}{iλ} ∫∫_Σ U(Q) \frac{e^{ikr}}{r} \cos(n, r) dΣ$$

其中 P 是观察点，Q 是孔径上的点，r = |P - Q| 是它们之间的距离。

惠更斯原理的数学表述：
- 每个波前元素都是次级球面波源
- 后续波前是所有次级波的包络
- 菲涅尔贡献：引入了相位和倾斜因子

倾斜因子的物理意义：
$$K(χ) = \frac{1 + \cos χ}{2}$$
其中 χ 是法向与观察方向的夹角。

#### 基尔霍夫衍射理论

从标量波动方程出发：
$$\nabla^2 U + k^2 U = 0$$

亥姆霍兹方程的格林函数解：
$$G(\mathbf{r}, \mathbf{r}') = \frac{e^{ik|\mathbf{r} - \mathbf{r}'|}}{4π|\mathbf{r} - \mathbf{r}'|}$$

应用格林定理，得到基尔霍夫积分：
$$U(P) = \frac{1}{4π} ∫∫_Σ \left[U\frac{∂G}{∂n} - G\frac{∂U}{∂n}\right] dΣ$$

展开后：
$$U(P) = \frac{1}{iλ} ∫∫_Σ U(Q) \frac{e^{ikr}}{r} \frac{1 + \cos χ}{2} dΣ$$

基尔霍夫边界条件（在孔径Σ上）：
- U = U_{incident}（孔径内）
- U = 0（屏幕上）
- ∂U/∂n = ∂U_{incident}/∂n（孔径内）
- ∂U/∂n = 0（屏幕上）

#### Rayleigh-Sommerfeld衍射公式

第一类Rayleigh-Sommerfeld公式（更精确）：
$$U(P) = \frac{1}{iλ} ∫∫_Σ U(Q) \frac{e^{ikr}}{r} \cos(n, r) dΣ$$

推导使用了更合理的边界条件：
- 仅指定U或∂U/∂n之一
- 避免了基尔霍夫理论的数学不一致性

第二类公式：
$$U(P) = -\frac{1}{iλ} ∫∫_Σ \frac{∂U}{∂n} \frac{e^{ikr}}{r} dΣ$$

两种公式的选择：
- 第一类：已知孔径平面的场分布U
- 第二类：已知孔径平面的场梯度∂U/∂n

### 2.4.2 菲涅尔衍射

在菲涅尔近似下（近场），传播核为：
$$h(x, y; x', y') = \frac{e^{ikz}}{iλz} exp\left[\frac{ik}{2z}[(x-x')^2 + (y-y')^2]\right]$$

衍射场为：
$$U(x, y) = ∫∫ U_0(x', y') h(x, y; x', y') dx' dy'$$

#### 菲涅尔近似的条件

菲涅尔近似成立的条件：
$$z^3 >> \frac{π}{4λ}[(x-x')^2 + (y-y')^2]_{max}^2$$

这确保了相位误差小于 π/8。

#### 例1：圆孔的菲涅尔衍射

考虑半径为 a 的圆孔，入射平面波。轴上场分布：
$$U(0, 0, z) = U_0 \left[1 - e^{ika^2/2z}\right]$$

强度分布：
$$I(0, 0, z) = 4I_0 \sin^2\left(\frac{ka^2}{4z}\right)$$

菲涅尔区数：$N = \frac{a^2}{λz}$

当 N 为奇数时，中心为亮点；N 为偶数时，中心为暗点。

#### 例2：直边的菲涅尔衍射

半平面屏的菲涅尔衍射，使用菲涅尔积分：
$$U(x) = \frac{1+i}{2} \left[C(v) + iS(v)\right]$$

其中菲涅尔参数：$v = x\sqrt{\frac{2}{λz}}$

菲涅尔积分：
$$C(v) = \int_0^v \cos\left(\frac{πt^2}{2}\right) dt$$
$$S(v) = \int_0^v \sin\left(\frac{πt^2}{2}\right) dt$$

#### 例3：菲涅尔波带片

菲涅尔波带片的透过率函数：
$$t(r) = \frac{1}{2}\left[1 + \cos\left(\frac{πr^2}{λf}\right)\right]$$

这相当于一个衍射透镜，焦距为 f。主焦点强度：
$$I_{focus} = \left(\frac{πa^2}{λf}\right)^2 I_0$$

### 2.4.3 夫琅禾费衍射

在远场（夫琅禾费区域），衍射简化为傅里叶变换：
$$U(x, y) = \frac{e^{ikz}}{iλz} e^{ik(x^2+y^2)/2z} \mathcal{F}\{U_0\}\left(\frac{x}{λz}, \frac{y}{λz}\right)$$

其中 $\mathcal{F}$ 表示傅里叶变换。

#### 夫琅禾费近似条件

夫琅禾费近似要求：
$$z >> \frac{k(x'^2 + y'^2)_{max}}{2} = \frac{πa^2}{λ}$$

这确保孔径上的二次相位项可忽略。

#### 例4：矩形孔径的夫琅禾费衍射

矩形孔径 (宽度 a × b) 的衍射图样：
$$U(x, y) = U_0 ab \frac{e^{ikz}}{iλz} \text{sinc}\left(\frac{ax}{λz}\right) \text{sinc}\left(\frac{by}{λz}\right)$$

其中 $\text{sinc}(x) = \frac{\sin(πx)}{πx}$。

强度分布：
$$I(x, y) = I_0 \left(\frac{ab}{λz}\right)^2 \text{sinc}^2\left(\frac{ax}{λz}\right) \text{sinc}^2\left(\frac{by}{λz}\right)$$

第一暗环位置：$x = ±\frac{λz}{a}$，$y = ±\frac{λz}{b}$

#### 例5：圆孔的夫琅禾费衍射（艾里斑）

圆孔（半径 a）的衍射：
$$U(r, θ) = U_0 \frac{πa^2}{iλz} e^{ikz} \frac{2J_1(kar/z)}{kar/z}$$

其中 J₁ 是一阶贝塞尔函数。

艾里斑特征：
- 中心最大值：$I_0 = \left(\frac{πa^2}{λz}\right)^2 I_{incident}$
- 第一暗环：$r = 1.22\frac{λz}{2a}$ (数值孔径 NA = a/z)
- 中心亮斑包含总功率的 83.8%

#### 例6：光栅的夫琅禾费衍射

N 条缝的光栅（缝宽 a，周期 d）：
$$I(θ) = I_0 \left(\frac{\sin(Nπd\sin θ/λ)}{N\sin(πd\sin θ/λ)}\right)^2 \left(\frac{\sin(πa\sin θ/λ)}{πa\sin θ/λ}\right)^2$$

主极大位置（光栅方程）：$d\sin θ_m = mλ$

分辨本领：$R = mN$（m 是衍射级次）

### 2.4.4 数值计算考虑

菲涅尔数 F = a²/(λz) 决定了使用哪种近似：
- F >> 1：几何光学
- F ≈ 1：菲涅尔衍射
- F << 1：夫琅禾费衍射

#### 衍射积分的数值方法

1. **直接积分法**：
   - 适用于任意孔径形状
   - 计算复杂度：O(N_output × N_aperture)

2. **FFT方法**（夫琅禾费）：
   - 利用衍射是傅里叶变换
   - 计算复杂度：O(N log N)

3. **角谱法**：
   $$U(x, y, z) = \mathcal{F}^{-1}\left\{\mathcal{F}\{U_0\} \exp\left[ikz\sqrt{1-(λf_x)^2-(λf_y)^2}\right]\right\}$$
   - 精确，无近似
   - 适用于近场传播

4. **菲涅尔卷积法**：
   - 使用卷积定理
   - 需要适当的采样以避免混叠

#### 采样要求

空间采样间隔：
- 菲涅尔衍射：$Δx < \sqrt{\frac{λz}{N}}$（N是采样点数）
- 夫琅禾费衍射：$Δx < \frac{λz}{L}$（L是观察区域尺寸）

避免混叠的条件：
$$Δx_{aperture} × Δx_{observation} ≤ \frac{λz}{N}$$

## 2.5 空间和时间相干性

### 2.5.1 互相干函数

两点间的互相干函数定义为：
$$Γ(r_1, r_2, τ) = \langle U^*(r_1, t) U(r_2, t + τ) \rangle$$

归一化后得到复相干度：
$$γ(r_1, r_2, τ) = \frac{Γ(r_1, r_2, τ)}{\sqrt{I(r_1)I(r_2)}}$$

### 2.5.2 时间相干性

时间相干性由相干时间 τ_c 和相干长度 l_c = cτ_c 表征。对于光谱宽度 Δν 的光源：
$$τ_c ≈ \frac{1}{Δν}$$

时间相干性影响干涉条纹的可见度：
$$V = |γ(τ)| = |\mathcal{F}\{S(ν)\}|$$

其中 S(ν) 是归一化光谱密度。

### 2.5.3 空间相干性

空间相干性由相干面积表征。根据van Cittert-Zernike定理，扩展非相干源产生的场的空间相干性为：
$$γ(r_1, r_2) = \frac{∫∫ I(ξ, η) e^{ik[(r_1-r_2)·(ξ,η)]/z} dξdη}{∫∫ I(ξ, η) dξdη}$$

对于均匀圆形源，相干半径为：
$$ρ_c ≈ 1.22 \frac{λz}{D}$$

其中 D 是源的直径，z 是观察距离。

### 2.5.4 相干性与渲染

在计算机图形学中，相干性影响：
- 散斑图案的形成
- 薄膜干涉的可见度
- 全息显示的质量
- 激光投影系统的设计

## 本章小结

本章建立了光场理论的数学基础，主要概念包括：

1. **4D/5D光场表示**：L(u, v, s, t, λ) 完整描述光的空间、角度和光谱分布
2. **全光函数**：七维函数 P(x, y, z, θ, φ, λ, t) 描述所有可能的视觉信息
3. **Wigner分布**：W(x, k) 统一了几何光学和波动光学的相空间表示
4. **衍射理论**：菲涅尔数 F = a²/(λz) 决定使用几何、菲涅尔或夫琅禾费近似
5. **相干性**：时间相干长度 l_c ≈ c/Δν，空间相干半径 ρ_c ≈ 1.22λz/D

这些概念为理解现代渲染技术（如光场相机、全息显示）提供了理论基础。

## 练习题

### 基础题

**练习 2.1**：证明两平面参数化的4D光场在自由空间传播时满足亮度守恒。  
*提示*：使用光线的参数方程和雅可比行列式。

<details>
<summary>答案</summary>

设光线从平面1 (u, v) 传播到平面2 (s, t)，距离为 d。光线方程为：
$$s = u + d \cdot \tan θ_x, \quad t = v + d \cdot \tan θ_y$$

雅可比行列式：
$$J = \left|\frac{∂(s,t)}{∂(u,v)}\right| = 1$$

因此 L(u, v, s, t) = L(u', v', s', t')，证明了亮度守恒。
</details>

**练习 2.2**：对于直径 D = 1 mm 的圆形非相干光源，波长 λ = 500 nm，计算在距离 z = 1 m 处的空间相干半径。  
*提示*：使用van Cittert-Zernike定理的结果。

<details>
<summary>答案</summary>

使用公式 ρ_c ≈ 1.22λz/D：
$$ρ_c = 1.22 × \frac{500 × 10^{-9} × 1}{10^{-3}} = 0.61 \text{ mm}$$

这意味着相距超过0.61 mm的两点基本不相干。
</details>

**练习 2.3**：推导菲涅尔数 F = 1 时的衍射场强度分布。  
*提示*：考虑圆孔的菲涅尔衍射积分。

<details>
<summary>答案</summary>

对于半径 a 的圆孔，F = a²/(λz) = 1 意味着 z = a²/λ。

轴上强度：
$$I(0) = I_0 |1 - e^{ika²/2z}|² = I_0 |1 - e^{iπ}|² = 4I_0$$

这是几何阴影强度的4倍，展示了菲涅尔衍射的聚焦效应。
</details>

### 挑战题

**练习 2.4**：推导Wigner分布函数通过薄透镜的变换规律。透镜焦距为 f。  
*提示*：薄透镜相位变换为 exp[-ik(x² + y²)/2f]。

<details>
<summary>答案</summary>

薄透镜引入二次相位：
$$U'(x) = U(x) \exp\left[-\frac{ik x²}{2f}\right]$$

Wigner分布变换为：
$$W'(x, k) = W(x, k + \frac{x}{f})$$

这是相空间中的另一种剪切变换，与自由传播的剪切方向正交。组合得到ABCD矩阵光学。
</details>

**练习 2.5**：证明部分相干光的4D光场表示需要考虑互相干函数 Γ(r₁, r₂)。推导相应的广义光场方程。  
*提示*：从统计光学出发，考虑场的二阶相关。

<details>
<summary>答案</summary>

部分相干光场不能用确定性函数L(u, v, s, t)描述。需要引入互强度：
$$J(u₁, v₁, u₂, v₂) = \langle L^*(u₁, v₁, s, t) L(u₂, v₂, s, t) \rangle$$

传播方程：
$$J(s₁, t₁, s₂, t₂) = ∫∫∫∫ h^*(s₁-u₁, t₁-v₁) h(s₂-u₂, t₂-v₂) J(u₁, v₁, u₂, v₂) du₁dv₁du₂dv₂$$

其中h是传播核。这导致光场维度翻倍：4D → 8D。
</details>

**练习 2.6**：设计一个算法，从多视角图像重建4D光场。分析采样要求和重建误差。  
*提示*：考虑极线几何约束和频域分析。

<details>
<summary>答案</summary>

算法框架：
1. 极线约束：对应点满足 x'ᵀFx = 0
2. 视差与深度：d = f·B/Z
3. 光场重建：L(u, v, s, t) = I(u + d(s-u)/z, v + d(t-v)/z)

采样要求（Nyquist）：
- 角度采样：Δθ < λ/D（D是场景尺度）
- 空间采样：Δx < λz/D（z是深度范围）

重建误差主要来自：
- 遮挡区域：O(遮挡面积/总面积)
- 深度误差：δL/L ≈ δZ/Z
- 混叠：当违反Nyquist条件时
</details>

### 开放性思考题

**练习 2.7**：讨论如何将传统光线追踪算法扩展以处理波动光学效应。考虑计算复杂度和精度权衡。  
*提示*：思考混合几何-波动方法。

<details>
<summary>答案</summary>

可能的方法：
1. **局部波动修正**：在需要时（如边缘、小孔）切换到波动计算
2. **相位光线追踪**：追踪复振幅而非仅强度
3. **Wigner函数光线追踪**：在相空间追踪，自然包含衍射

复杂度分析：
- 纯几何：O(N log N)（N是光线数）
- 局部波动：O(N log N + M·K²)（M是衍射区域，K是采样点）
- 全波动：O(N³)（体积离散化）

建议：根据菲涅尔数自适应选择方法。
</details>

**练习 2.8**：探讨机器学习如何用于光场压缩和重建。设计一个网络架构并分析其理论基础。  
*提示*：考虑光场的低秩结构和稀疏性。

<details>
<summary>答案</summary>

网络架构建议：
1. **编码器**：4D卷积提取光场特征
2. **低秩分解**：类似TensoRF的向量-矩阵分解
3. **解码器**：上采样重建完整光场

理论基础：
- 光场在无遮挡区域是低秩的（秩 ≤ 场景复杂度）
- 傅里叶域稀疏性（大部分能量集中在低频）
- 极线一致性提供额外约束

损失函数：
$$\mathcal{L} = ||L - L_{gt}||_2 + λ_1||∇L||_1 + λ_2 \mathcal{L}_{epi}$$

其中 $\mathcal{L}_{epi}$ 是极线一致性损失。
</details>

## 常见陷阱与错误

### 陷阱 1：混淆4D光场的不同参数化
**错误**：直接在 (x, y, θ, φ) 和 (u, v, s, t) 之间转换  
**正确**：需要考虑坐标系和采样结构的差异

### 陷阱 2：忽略相干性在干涉中的作用
**错误**：假设所有光源都能产生稳定干涉  
**正确**：只有相干长度内的光程差才能产生干涉

### 陷阱 3：错误使用菲涅尔近似
**错误**：在近场直接使用夫琅禾费公式  
**正确**：检查菲涅尔数F，选择合适的近似

### 陷阱 4：Wigner分布的物理解释
**错误**：将W(x, k)解释为位置x处沿方向k的强度  
**正确**：W可以为负，是准概率分布

### 陷阱 5：光场采样不足
**错误**：使用稀疏相机阵列重建光场  
**正确**：满足角度和空间Nyquist条件

## 最佳实践检查清单

### 光场表示选择
- [ ] 根据应用选择合适的参数化（光线角度 vs 两平面）
- [ ] 考虑是否需要时间和光谱维度
- [ ] 评估存储和计算需求

### 衍射计算
- [ ] 计算菲涅尔数确定适用的近似
- [ ] 验证采样满足Nyquist条件
- [ ] 考虑边界效应和零填充

### 相干性分析
- [ ] 识别光源类型（激光/LED/热光源）
- [ ] 计算相干长度和相干面积
- [ ] 在设计光学系统时考虑相干性限制

### 数值实现
- [ ] 使用FFT加速卷积计算
- [ ] 注意相位展开和2π模糊
- [ ] 验证能量守恒

### 算法优化
- [ ] 利用光场的稀疏性和低秩性
- [ ] 考虑空间-角度分辨率权衡
- [ ] 实现自适应采样策略